# 白屏检测实现说明

## 目录
1. 概述
2. 默认配置
3. 触发流程
4. 内容判定规则
5. 上报与防抖
6. 配置更新与销毁
7. 开发演示与手动上报
8. 可扩展点

---

## 1. 概述
- 位置：`src/sdk/index.ts`
- 目标：自动检测页面是否出现“白屏”（根节点无有效内容），满足阈值后上报 `blankScreen` 事件，避免用户长时间空白体验并便于监控。
- 手段：`MutationObserver` + 定时轮询双重检测，结合可见性切换重置，降低误报。

---

## 2. 默认配置
```231:239:src/sdk/index.ts
this.blankScreenConfig = {
  enabled: true,           // 默认启用
  checkInterval: 3000,     // 每3秒检测一次
  rootSelector: '#root',   // 根节点选择器
  threshold: 5000,         // 5秒无内容判定白屏
  checkElements: ['#root', 'body'], // 额外关键元素
  ...blankScreenConfig
};
```
- 初始化顺序：错误捕获 → 批量机制 → **白屏检测启动** → 离线事件加载。

---

## 3. 触发流程
```1708:1743:src/sdk/index.ts
initBlankScreenDetection():
  - 若文档未加载，等 DOMContentLoaded 后启动
  - 若已加载，延迟 2s（给 React 渲染时间）
  - startBlankScreenDetection():
      * initMutationObserver()
      * startBlankScreenTimer()  // setInterval 按 checkInterval 轮询
      * 监听 visibilitychange，页面可见时重置并立即检测
```

---

## 4. 内容判定规则
```1795:1827:src/sdk/index.ts
checkBlankScreen():
  - 已上报则跳过（blankScreenReported 防抖）
  - 获取 rootSelector 元素，判定 hasPageContent()
  - 无内容且超 threshold -> reportBlankScreen()
  - 有内容 -> 刷新 lastContentCheckTime
```
```1830:1880:src/sdk/index.ts
hasPageContent(element):
  - 非空文本
  - 子元素递归有内容
  - 存在 img / svg / canvas
  - checkElements 中的关键选择器存在且有内容
```
> 只要任一条件满足即视为有内容，避免正常页面被误判。

---

## 5. 上报与防抖
```1884:1892:src/sdk/index.ts
reportBlankScreen(details):
  track('blankScreen', { 白屏类型: '页面无内容', ...details }, 'high');
  console.warn('检测到白屏:', details);
```
- 事件优先级高，便于监控快速落盘。
- `blankScreenReported` 避免重复上报；DOM 变化或页面重新可见时重置。

---

## 6. 配置更新与销毁
```1903:1918:src/sdk/index.ts
updateBlankScreenConfig(newConfig):
  - 启用 -> 初始化
  - 禁用 -> destroyBlankScreenDetection()
  - 启用状态下更新 -> 先销毁再重启
```
```1921:1931:src/sdk/index.ts
destroyBlankScreenDetection():
  - 停止轮询定时器
  - 断开 MutationObserver
  - 重置 blankScreenReported
```
- 状态查询：`getBlankScreenStatus()` 返回开关与当前配置。

---

## 7. 开发演示与手动上报
- 演示页面：`src/pages/SDKModule/index.tsx`
  - “模拟白屏事件”按钮：`trackBlankScreen('手动模拟白屏', {...})`
  - “查看检测状态”按钮：`getBlankScreenStatus()` 弹出当前配置
  - 说明文案列出默认 3s 检测 / 5s 阈值 / MutationObserver。
```134:153:src/pages/SDKModule/index.tsx
simulateBlankScreen() -> sdk.trackBlankScreen(...)
getBlankScreenStatus() -> sdk.getBlankScreenStatus()
```
- 手动上报 API：`trackBlankScreen(type, details)` 供业务自定义。

---

## 8. 可扩展点
- 接入监控：在 `reportBlankScreen` 中对接 Sentry/埋点后端，附加首屏指标、网络状态等上下文。
- 自定义判定：根据业务添加关键选择器或调整 `threshold`/`checkInterval`。
- 误报治理：结合首屏骨架/Loading 占位元素，确保有占位时不被判定白屏。


