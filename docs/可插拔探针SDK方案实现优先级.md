## 可插拔探针 SDK 方案实现优先级

### 优先级分层说明
- P0：必须首批完成，决定方案可用性与后续验证。
- P1：优先迭代，完善主要探针与适配。
- P2：优化与增强，提升鲁棒性与体验。
- P3：可选增强，依据资源与需求决定。

### 阶段划分与任务列表
#### 阶段1（P0）核心能力落地
- SDK 核心抽象：拆分 `core/transport`、`core/api`、`config`，确定事件统一格式与公共类型定义。
- 传输管道：批量队列、自适应批量、指数退避、Beacon 收尾、离线缓存、压缩策略骨架。
- API 接口：`init / track / trackError / trackPage / trackHttp / trackPerf / flush` 最小可用实现。
- 上报协议与 `/track` 接口对接：落日志/单表写入流程跑通（先简版存储）。
- 构建输出：tsup/rollup 配置产出 UMD/ESM/IIFE + d.ts，npm/CDN 双形态。

#### 阶段2（P1）关键探针与适配
- 错误探针：JS Error、Promise rejection、资源错误、console 重写，支持 SourceMap 钩子占位。
- HTTP 探针：XHR/Fetch 拦截，采集 URL/method/status/duration/体积，白名单/忽略与脱敏配置。
- 性能探针基础：FCP/LCP/CLS/TTFB/长任务，PerformanceObserver 采集；采样率控制。
- 行为与会话基础：自动 PV、路由切换监听（history/hash/pushstate 适配层）。
- 配置体系：enable 开关、采样率、忽略与脱敏规则；默认配置与校验。
- 示例与快速开始：React/Vue/原生最小示例，路由监听演示。

#### 阶段3（P2）可靠性与体验优化
- 离线与弱网策略完善：缓存上限、持久化策略、重试限流与回退。
- 批量策略优化：自适应批量阈值调优，最大 payload/条数限制。
- 白屏检测：rootSelector/阈值/检查元素配置，复用现有实现并接入批量上报。
- 行为增强：停留时长、曝光/点击可选采集；Session 关联（轻量）。
- 安全与隐私：字段脱敏、URL 白名单、Headers/Body mask、最大 payload 校验。
- 体积控制：可选子包拆分（录屏/高级性能指标延迟加载）。

#### 阶段4（P3）可选增强与运营
- 录屏/回放能力接入与拆包。
- 高阶性能指标与资源 timing 细化。
- 告警与 Webhook：阈值配置、通知管道。
- 可视化/看板对接与聚合查询（ClickHouse/OLAP）。
- 发布流程完善：版本规范、变更日志、灰度策略。

### 依赖与里程碑
- 里程碑 M1（完成 P0）：SDK 核心 + 传输管道 + 构建输出 + /track 最小闭环。
- 里程碑 M2（完成 P1）：错误/HTTP/性能基础探针 + 路由适配 + 示例。
- 里程碑 M3（完成 P2）：可靠性完善 + 白屏/行为增强 + 安全与体积优化。
- 里程碑 M4（按需 P3）：录屏/告警/看板等可选能力。

### 验证与测试建议
- 单元：核心队列、退避、配置校验、API 输出。
- 集成：弱网/离线/Beacon 收尾、批量阈值、最大 payload 限制。
- 探针专项：错误、HTTP、性能指标采集准确性；路由切换与 PV 上报完整性。
- 压测：高并发批量上报、缓存溢出、长时间运行内存占用。


