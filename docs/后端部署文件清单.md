# åç«¯éƒ¨ç½²æ–‡ä»¶æ¸…å•

æœ¬æ–‡æ¡£åˆ—å‡ºéœ€è¦ä¸Šä¼ åˆ°æœåŠ¡å™¨çš„åç«¯æ–‡ä»¶ã€‚

## ğŸ“ æœåŠ¡å™¨è·¯å¾„

```
/www/wwwroot/default/server/
```

## âœ… å¿…é¡»ä¸Šä¼ çš„æ–‡ä»¶

### 1. æºä»£ç ç›®å½•
```
server/src/                    # å®Œæ•´çš„ TypeScript æºç ç›®å½•
â”œâ”€â”€ app.ts                     # ä¸»å…¥å£æ–‡ä»¶
â”œâ”€â”€ database/                  # æ•°æ®åº“ç›¸å…³
â”‚   â”œâ”€â”€ connection.ts
â”‚   â””â”€â”€ schema.sql
â”œâ”€â”€ db/                        # æ•°æ®åº“è¿æ¥æ± 
â”‚   â”œâ”€â”€ index.ts
â”‚   â””â”€â”€ schema.sql
â”œâ”€â”€ routes/                    # è·¯ç”±æ–‡ä»¶
â”‚   â”œâ”€â”€ api.ts
â”‚   â”œâ”€â”€ eventDefinitions.ts
â”‚   â””â”€â”€ stats.ts
â”œâ”€â”€ services/                  # æœåŠ¡å±‚
â”‚   â”œâ”€â”€ aiService.ts
â”‚   â”œâ”€â”€ anomalyDetectionService.ts
â”‚   â”œâ”€â”€ emailService.ts
â”‚   â”œâ”€â”€ eventDefinitionService.ts
â”‚   â”œâ”€â”€ predictionRecordService.ts
â”‚   â”œâ”€â”€ predictionService.ts
â”‚   â”œâ”€â”€ schedulerService.ts
â”‚   â”œâ”€â”€ statsService.ts
â”‚   â”œâ”€â”€ summaryService.ts
â”‚   â”œâ”€â”€ trackingService.ts
â”‚   â””â”€â”€ userService.ts
â”œâ”€â”€ swagger.ts                 # API æ–‡æ¡£é…ç½®
â””â”€â”€ utils/                     # å·¥å…·å‡½æ•°
    â”œâ”€â”€ cache.ts
    â””â”€â”€ crypto.ts
```

### 2. é…ç½®æ–‡ä»¶
```
server/
â”œâ”€â”€ package.json               # â­ å¿…éœ€ï¼šä¾èµ–é…ç½®
â”œâ”€â”€ pnpm-lock.yaml            # â­ å¿…éœ€ï¼šé”å®šç‰ˆæœ¬
â”œâ”€â”€ tsconfig.json             # â­ å¿…éœ€ï¼šTypeScript é…ç½®
â””â”€â”€ ecosystem.config.js        # â­ å¿…éœ€ï¼šPM2 é…ç½®æ–‡ä»¶
```

### 3. åˆå§‹åŒ–è„šæœ¬
```
server/
â”œâ”€â”€ init-database.js          # â­ å¿…éœ€ï¼šæ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
â””â”€â”€ init-db.sql              # â­ å¿…éœ€ï¼šæ•°æ®åº“ SQL è„šæœ¬
```

### 4. éƒ¨ç½²è„šæœ¬ï¼ˆå¯é€‰ä½†æ¨èï¼‰
```
server/
â”œâ”€â”€ restart-pm2.sh            # PM2 é‡å¯è„šæœ¬
â””â”€â”€ restart-with-env.sh      # å¸¦ç¯å¢ƒå˜é‡çš„é‡å¯è„šæœ¬
```

### 5. SQL è„šæœ¬ï¼ˆæŒ‰éœ€ï¼‰
```
server/
â”œâ”€â”€ add_prediction_records_table.sql
â”œâ”€â”€ optimize_database_indexes.sql
â””â”€â”€ optimize_database_indexes_simple.sql
```

## âŒ ä¸éœ€è¦ä¸Šä¼ çš„æ–‡ä»¶

ä»¥ä¸‹æ–‡ä»¶**ä¸è¦ä¸Šä¼ **ï¼Œä¼šåœ¨æœåŠ¡å™¨ä¸Šç”Ÿæˆæˆ–åˆ›å»ºï¼š

### 1. ç¼–è¯‘äº§ç‰©ï¼ˆä¼šè‡ªåŠ¨ç”Ÿæˆï¼‰
```
server/dist/                  # âŒ ä¸è¦ä¸Šä¼ ï¼Œè¿è¡Œ pnpm run build ç”Ÿæˆ
```

### 2. ä¾èµ–åŒ…ï¼ˆä¼šè‡ªåŠ¨å®‰è£…ï¼‰
```
server/node_modules/          # âŒ ä¸è¦ä¸Šä¼ ï¼Œè¿è¡Œ pnpm install å®‰è£…
```

### 3. ç¯å¢ƒå˜é‡æ–‡ä»¶ï¼ˆéœ€è¦æ‰‹åŠ¨åˆ›å»ºï¼‰
```
server/.env                  # âŒ ä¸è¦ä¸Šä¼ ï¼Œåœ¨æœåŠ¡å™¨ä¸Šæ‰‹åŠ¨åˆ›å»º
server/.env.local            # âŒ ä¸è¦ä¸Šä¼ 
server/.env.prod             # âŒ ä¸è¦ä¸Šä¼ 
```

### 4. æ•æ„Ÿæ–‡ä»¶
```
server/keys/                 # âŒ ä¸è¦ä¸Šä¼ ï¼ŒåŒ…å«å¯†é’¥æ–‡ä»¶
```

### 5. æµ‹è¯•æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
```
server/test_*.js             # å¯é€‰ï¼šæµ‹è¯•æ–‡ä»¶
server/test_*.py             # å¯é€‰ï¼šæµ‹è¯•æ–‡ä»¶
server/generate_*.py         # å¯é€‰ï¼šæ•°æ®ç”Ÿæˆè„šæœ¬
server/generate_*.sql        # å¯é€‰ï¼šæ•°æ®ç”Ÿæˆè„šæœ¬
```

### 6. æ–‡æ¡£ï¼ˆå¯é€‰ï¼‰
```
server/doc/                  # å¯é€‰ï¼šæ–‡æ¡£ç›®å½•
server/*.md                  # å¯é€‰ï¼šMarkdown æ–‡æ¡£
```

## ğŸ“¦ å¿«é€Ÿä¸Šä¼ æ¸…å•

### æ–¹å¼ä¸€ï¼šä½¿ç”¨ tar å‹ç¼©åŒ…ï¼ˆæ¨èï¼‰

åœ¨æœ¬åœ°é¡¹ç›®ç›®å½•æ‰§è¡Œï¼š

```bash
cd server

# åˆ›å»ºå‹ç¼©åŒ…ï¼ˆæ’é™¤ä¸éœ€è¦çš„æ–‡ä»¶ï¼‰
tar -czf server-deploy.tar.gz \
  --exclude='node_modules' \
  --exclude='dist' \
  --exclude='.env*' \
  --exclude='keys' \
  --exclude='*.log' \
  src/ \
  package.json \
  pnpm-lock.yaml \
  tsconfig.json \
  ecosystem.config.js \
  init-database.js \
  init-db.sql \
  restart-pm2.sh \
  restart-with-env.sh \
  *.sql

# ä¸Šä¼ åˆ°æœåŠ¡å™¨
scp server-deploy.tar.gz root@120.26.41.57:/www/wwwroot/default/

# åœ¨æœåŠ¡å™¨ä¸Šè§£å‹
ssh root@120.26.41.57
cd /www/wwwroot/default
tar -xzf server-deploy.tar.gz -C server/
```

### æ–¹å¼äºŒï¼šä½¿ç”¨ rsyncï¼ˆæ¨èï¼Œå¢é‡åŒæ­¥ï¼‰

```bash
# ä»æœ¬åœ°åŒæ­¥åˆ°æœåŠ¡å™¨ï¼ˆæ’é™¤ä¸éœ€è¦çš„æ–‡ä»¶ï¼‰
rsync -avz --progress \
  --exclude='node_modules' \
  --exclude='dist' \
  --exclude='.env*' \
  --exclude='keys' \
  --exclude='*.log' \
  --exclude='test_*' \
  --exclude='generate_*' \
  --exclude='doc' \
  server/ root@120.26.41.57:/www/wwwroot/default/server/
```

### æ–¹å¼ä¸‰ï¼šä½¿ç”¨ Gitï¼ˆå¦‚æœæœåŠ¡å™¨æœ‰ Gitï¼‰

```bash
# åœ¨æœåŠ¡å™¨ä¸Š
cd /www/wwwroot/default
git clone <your-repo-url> temp-repo
cp -r temp-repo/server/* server/
rm -rf temp-repo
```

## ğŸš€ ä¸Šä¼ åçš„éƒ¨ç½²æ­¥éª¤

### 1. å®‰è£…ä¾èµ–

```bash
cd /www/wwwroot/default/server
pnpm install --production
```

### 2. æ„å»ºé¡¹ç›®

```bash
pnpm run build
```

### 3. åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶

```bash
# åˆ›å»º .env æ–‡ä»¶
cat > .env << EOF
PORT=3000
NODE_ENV=production
DB_HOST=127.0.0.1
DB_PORT=3306
DB_USER=analytics_user
DB_PASSWORD=your_password
DB_NAME=analytics_platform
DB_POOL_LIMIT=20
JWT_SECRET=your_jwt_secret
JWT_EXPIRES_IN=7d
OPENAI_API_KEY=sk-your-key
OPENAI_BASE_URL=https://api.openai.com/v1
OPENAI_MODEL=gpt-3.5-turbo
ML_SERVICE_URL=http://localhost:5000
EOF
```

### 4. åˆå§‹åŒ–æ•°æ®åº“ï¼ˆå¦‚æœéœ€è¦ï¼‰

```bash
node dist/init-database.js
```

### 5. å¯åŠ¨æœåŠ¡

```bash
# ä½¿ç”¨ PM2 å¯åŠ¨
pm2 start ecosystem.config.js

# æˆ–ä½¿ç”¨é‡å¯è„šæœ¬
bash restart-pm2.sh
```

### 6. éªŒè¯æœåŠ¡

```bash
# æŸ¥çœ‹ PM2 çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs analytics-api

# æµ‹è¯• API
curl http://127.0.0.1:3000/api/health
```

## ğŸ“‹ æ–‡ä»¶æ¸…å•æ€»ç»“

### æœ€å°å¿…éœ€æ–‡ä»¶ï¼ˆç²¾ç®€ç‰ˆï¼‰

```
server/
â”œâ”€â”€ src/                      # å®Œæ•´æºç ç›®å½•
â”œâ”€â”€ package.json
â”œâ”€â”€ pnpm-lock.yaml
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ ecosystem.config.js
â”œâ”€â”€ init-database.js
â””â”€â”€ init-db.sql
```

### å®Œæ•´æ¨èæ–‡ä»¶ï¼ˆåŒ…å«å·¥å…·è„šæœ¬ï¼‰

```
server/
â”œâ”€â”€ src/                      # å®Œæ•´æºç ç›®å½•
â”œâ”€â”€ package.json
â”œâ”€â”€ pnpm-lock.yaml
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ ecosystem.config.js
â”œâ”€â”€ init-database.js
â”œâ”€â”€ init-db.sql
â”œâ”€â”€ restart-pm2.sh
â”œâ”€â”€ restart-with-env.sh
â””â”€â”€ *.sql                     # å…¶ä»– SQL è„šæœ¬
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ç¯å¢ƒå˜é‡**ï¼š`.env` æ–‡ä»¶åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œä¸è¦ä¸Šä¼ ï¼Œåœ¨æœåŠ¡å™¨ä¸Šæ‰‹åŠ¨åˆ›å»º
2. **å¯†é’¥æ–‡ä»¶**ï¼š`keys/` ç›®å½•åŒ…å« RSA å¯†é’¥ï¼Œä¸è¦ä¸Šä¼ 
3. **æ„å»ºäº§ç‰©**ï¼š`dist/` ç›®å½•å¯ä»¥åœ¨æœåŠ¡å™¨ä¸Šé‡æ–°æ„å»ºï¼Œä¸éœ€è¦ä¸Šä¼ 
4. **ä¾èµ–åŒ…**ï¼š`node_modules/` ä½“ç§¯å¤§ï¼Œåœ¨æœåŠ¡å™¨ä¸Šå®‰è£…æ›´å¿«
5. **æ–‡ä»¶æƒé™**ï¼šç¡®ä¿è„šæœ¬æ–‡ä»¶æœ‰æ‰§è¡Œæƒé™
   ```bash
   chmod +x restart-pm2.sh
   chmod +x restart-with-env.sh
   ```

## ğŸ” éªŒè¯ä¸Šä¼ 

ä¸Šä¼ å®Œæˆåï¼Œæ£€æŸ¥æ–‡ä»¶ï¼š

```bash
cd /www/wwwroot/default/server

# æ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la src/
ls -la package.json
ls -la ecosystem.config.js
ls -la init-database.js

# æ£€æŸ¥æ–‡ä»¶æ•°é‡
find src -type f | wc -l
```

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœä¸Šä¼ åé‡åˆ°é—®é¢˜ï¼š
1. æ£€æŸ¥æ–‡ä»¶æƒé™
2. æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®
3. æŸ¥çœ‹ PM2 æ—¥å¿—ï¼š`pm2 logs analytics-api`
4. æ£€æŸ¥æ•°æ®åº“è¿æ¥ï¼š`node check-env.js`

