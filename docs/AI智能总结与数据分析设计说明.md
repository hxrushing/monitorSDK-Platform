# AI 智能总结与数据分析设计说明

## 📋 概述

本文档详细说明 SDK 平台中 AI 智能总结功能的实现方案，探讨如何利用大语言模型（LLM）对海量埋点数据进行提炼，并转化为可指导性能优化与业务决策的洞察建议。

---

## 一、AI 智能总结的实现方案

AI 总结功能由 `AIService` 和 `SummaryService` 协同完成，通过“数据采集 -> 提炼预处理 -> AI 生成 -> 结果推送”的完整链路实现。

### 1.1 核心架构

```
┌──────────────┐      ┌─────────────────┐      ┌──────────────┐
│  数据库 (MySQL) │ ───→ │  SummaryService │ ───→ │  AIService   │
└──────────────┘      └────────┬────────┘      └──────┬───────┘
                               │                      │
                               ▼                      ▼
                        ┌──────────────┐      ┌─────────────────┐
                        │  任务进度跟踪  │      │  OpenAI / LLM   │
                        └──────────────┘      └─────────────────┘
```

### 1.2 数据提炼（SummaryData）

在发送给 AI 之前，系统先从原始埋点数据中提取核心指标，形成结构化的 `SummaryData`：

```typescript
export interface SummaryData {
  projectName: string;
  stats: {
    pv: number;          // 页面访问量
    uv: number;          // 独立访客数
    avgPages: number;    // 人均页面数
    avgDuration: number; // 平均停留时长
  };
  topEvents: Array<{     // 热门业务事件
    eventName: string;
    count: number;
  }>;
  trends: {              // 环比趋势
    pvChange: number;
    uvChange: number;
  };
}
```

### 1.3 核心技术挑战与解决方案

#### 1. 精准的 Token 估算
为了避免请求超限并优化成本，SDK 使用 `tiktoken` 库进行像素级的 Token 计算。
- **方案**：根据不同模型（如 `gpt-3.5-turbo`, `gpt-4`）自动选择编码器。
- **缓存**：缓存编码器实例，减少内存抖动。

#### 2. 大数据量的分批处理（Batching）
当监控的项目过多或数据详情太长时，单次 Prompt 会超过 LLM 的上下文窗口。
- **策略**：自动根据 Token 计数将数据拆分为多个批次。
- **递归总结**：对各批次的总结结果进行二次提炼，生成全局总览报告。

#### 3. 容错与降级
- **指数退避**：API 调用失败时自动重试。
- **基础总结兜底**：若 AI 服务不可用，自动切换到基于模板的统计总结。

---

## 二、如何帮助优化性能

AI 能够从冰冷的指标中读出“用户的痛苦”，提供比图表更直观的性能优化方向。

### 2.1 停留时长与卡顿关联分析
AI 通过分析 `avgDuration`（停留时长）与 `page_view` 的变化趋势：
- **洞察**：如果 PV 增加但停留时长骤减，AI 会提示：“用户访问量增加但无法留存，建议排查页面加载速度或是否存在 JS Error 阻塞了交互。”

### 2.2 异常流量识别
通过对 `pvChange` 的剧烈波动分析：
- **建议**：自动识别爬虫特征或异常接口调用，提示开发人员优化后端限流策略或前端请求频率。

### 2.3 性能瓶颈预警
结合 Web Vitals 数据（如 LCP、CLS）：
- **决策**：AI 总结会指出：“LCP 指标与人均访问页面数呈负相关，优化首屏渲染效率可有效提升用户深度访问意愿。”

---

## 三、如何助力业务决策

将埋点数据转化为“人话”，让产品经理和业务方能快速看懂数据背后的商业价值。

### 3.1 热门事件（Top Events）深度提炼
不只是展示前三名，AI 会分析事件的属性：
- **分析**：发现“搜索”事件环比下降 20%，但“分类浏览”上升 15%。
- **决策建议**：AI 提示：“用户搜索意愿下降，可能搜索质量存在问题，建议优化搜索算法或加强分类导航的推荐精度。”

### 3.2 趋势背后的归因分析
AI 结合 PV/UV 趋势与业务事件：
- **洞察**：如果新版本发布后 UV 稳定但关键转化事件（如 `add_to_cart`）下降。
- **决策建议**：AI 指出：“新版本 UI 调整可能增加了用户操作链路，建议进行路径流失分析，排查购物车按钮的可见性。”

### 3.3 自动化日报推送
- **价值**：每天早晨自动推送 AI 总结到开发者/产品经理邮箱或机器人群。
- **效果**：无需登录后台翻看各种看板，一分钟掌握全天业务动态。

---

## 四、设计亮点总结

1.  **任务进度可视化**：通过 SSE 或 WebSocket 实时展示 AI 生成进度（收集数据 -> 估算 Token -> 生成报告），提升用户体验。
2.  **Prompt 工程精置**：采用“角色设定 + 结构化约束 + 建议输出”的 Prompt 策略，确保总结结果简洁、专业且具有可操作性。
3.  **多维度数据融合**：将性能指标（Web Vitals）与业务埋点事件无缝融合，提供全貌分析。

---

## 五、未来演进

1.  **AI 自动化根因诊断**：当性能指标突降时，AI 自动对比代码提交历史，定位潜在的 Bug 或性能退化点。
2.  **预测性分析**：基于历史趋势，预测下一周的流量高峰，指导服务器扩容计划。
3.  **个性化建议**：根据不同角色（开发者、PM、运营）生成不同侧重点的定制化总结。

---

## 六、总结

AI 智能总结不仅是一个数据“提炼器”，更是监控系统的“指挥官”。它通过对海量埋点数据的实时扫描与智能理解，缩短了从“发现问题”到“解决问题”的链路，真正实现了数据驱动性能优化与业务增长。

