    # è·¯ç”±æ‡’åŠ è½½å®ç°ä¸æ€§èƒ½ä¼˜åŒ–æŒ‡å—

    ## ä¸€ã€è·¯ç”±æ‡’åŠ è½½çš„æ ¸å¿ƒåŸç†

    ### 1.1 React.lazy() çš„å·¥ä½œåŸç†

    `React.lazy()` æ˜¯ React æä¾›çš„ä»£ç åˆ†å‰²å’Œæ‡’åŠ è½½æœºåˆ¶ï¼Œå®ƒçš„å·¥ä½œåŸç†å¦‚ä¸‹ï¼š

    ```typescript
    const Component = lazy(() => import('./Component'));
    ```

    **æ‰§è¡Œæµç¨‹ï¼š**
    1. **åŠ¨æ€å¯¼å…¥**ï¼š`import()` è¿”å›ä¸€ä¸ª Promiseï¼Œåœ¨ç»„ä»¶é¦–æ¬¡æ¸²æŸ“æ—¶æ‰ä¼šæ‰§è¡Œ
    2. **ä»£ç åˆ†å‰²**ï¼šæ„å»ºå·¥å…·ï¼ˆVite/Webpackï¼‰ä¼šä¸ºæ¯ä¸ªæ‡’åŠ è½½ç»„ä»¶ç”Ÿæˆç‹¬ç«‹çš„ chunk æ–‡ä»¶
    3. **æŒ‰éœ€åŠ è½½**ï¼šåªæœ‰å½“è·¯ç”±åŒ¹é…æ—¶ï¼Œæ‰ä¼šé€šè¿‡ç½‘ç»œè¯·æ±‚åŠ è½½å¯¹åº”çš„ chunk
    4. **ç»„ä»¶æ¸²æŸ“**ï¼šåŠ è½½å®Œæˆåï¼ŒPromise resolveï¼ŒReact æ¸²æŸ“ç»„ä»¶

    ### 1.2 Suspense çš„ä½œç”¨

    `Suspense` ç”¨äºå¤„ç†å¼‚æ­¥ç»„ä»¶çš„åŠ è½½çŠ¶æ€ï¼š

    ```typescript
    <Suspense fallback={<Loading />}>
    <LazyComponent />
    </Suspense>
    ```

    **åŠŸèƒ½ï¼š**
    - åœ¨ç»„ä»¶åŠ è½½æœŸé—´æ˜¾ç¤º `fallback` UI
    - æä¾›ç»Ÿä¸€çš„åŠ è½½çŠ¶æ€ç®¡ç†
    - é…åˆé”™è¯¯è¾¹ç•Œå¤„ç†åŠ è½½å¤±è´¥çš„æƒ…å†µ

    ## äºŒã€å½“å‰é¡¹ç›®çš„å®ç°æ–¹å¼

    ### 2.1 è·¯ç”±é…ç½®ç»“æ„

    é¡¹ç›®ä½¿ç”¨ `react-router-dom v7` çš„ `createBrowserRouter`ï¼Œæ‰€æœ‰è·¯ç”±ç»„ä»¶éƒ½ä½¿ç”¨ `lazy()` åŒ…è£…ï¼š

    ```typescript
    // æ‰€æœ‰è·¯ç”±ç»„ä»¶éƒ½æ‡’åŠ è½½
    const Dashboard = lazy(() => import('@/pages/Dashboard'));
    const EventAnalysis = lazy(() => import('@/pages/EventAnalysis'));
    // ... å…¶ä»–è·¯ç”±
    ```

    ### 2.2 ç»Ÿä¸€çš„ Suspense åŒ…è£…

    ä½¿ç”¨ `withSuspense` é«˜é˜¶å‡½æ•°ç»Ÿä¸€å¤„ç†ï¼š

    ```typescript
    const withSuspense = (node: JSX.Element) => (
    <Suspense fallback={<RouteLoading />}>{node}</Suspense>
    );
    ```

    **ä¼˜åŠ¿ï¼š**
    - ä»£ç ç®€æ´ï¼Œé¿å…é‡å¤
    - ç»Ÿä¸€çš„åŠ è½½çŠ¶æ€
    - æ˜“äºç»´æŠ¤å’Œä¿®æ”¹

    ### 2.3 é”™è¯¯è¾¹ç•Œå¤„ç†

    æ¯ä¸ªè·¯ç”±éƒ½é…ç½®äº† `errorElement`ï¼Œä½¿ç”¨ `RouteErrorBoundary` å¤„ç†é”™è¯¯ï¼š

    ```typescript
    {
    path: 'dashboard',
    element: withSuspense(<Dashboard />),
    errorElement: <RouteErrorBoundary />,
    }
    ```

    ## ä¸‰ã€æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

    ### 3.1 æ„å»ºä¼˜åŒ–ï¼ˆå·²å®ç°ï¼‰

    åœ¨ `vite.config.ts` ä¸­å·²ç»é…ç½®äº†æ‰‹åŠ¨åˆ†åŒ…ï¼š

    ```typescript
    manualChunks: {
    'react-vendor': ['react', 'react-dom', 'react-router-dom'],
    'antd-vendor': ['antd', '@ant-design/icons'],
    'charts-vendor': ['@ant-design/plots'],
    'utils-vendor': ['dayjs', 'lodash', 'axios', 'zustand'],
    'sdk-vendor': ['src/sdk/index.ts'],
    }
    ```

    **ä¼˜åŠ¿ï¼š**
    - å¤§å‹ä¾èµ–åº“å•ç‹¬æ‰“åŒ…ï¼Œä¾¿äºç¼“å­˜
    - å‡å°‘é‡å¤æ‰“åŒ…
    - æé«˜åŠ è½½æ•ˆç‡

    ### 3.2 è·¯ç”±é¢„åŠ è½½ï¼ˆæ¨èå®ç°ï¼‰

    #### 3.2.1 ä½¿ç”¨åœºæ™¯

    1. **é¼ æ ‡æ‚¬åœé¢„åŠ è½½**ï¼šç”¨æˆ·æ‚¬åœèœå•é¡¹æ—¶é¢„åŠ è½½
    2. **å…³é”®è·¯ç”±é¢„åŠ è½½**ï¼šåº”ç”¨åˆå§‹åŒ–åé¢„åŠ è½½å¸¸ç”¨é¡µé¢
    3. **æ™ºèƒ½é¢„åŠ è½½**ï¼šæ ¹æ®ç”¨æˆ·è¡Œä¸ºé¢„æµ‹å¯èƒ½è®¿é—®çš„é¡µé¢

    #### 3.2.2 å®ç°æ–¹å¼

    å·²åˆ›å»º `src/utils/routePreloader.ts` å·¥å…·æ–‡ä»¶ï¼Œæä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š

    ```typescript
    // é¢„åŠ è½½å•ä¸ªè·¯ç”±
    preloadRoute('dashboard');

    // æ‰¹é‡é¢„åŠ è½½
    preloadRoutes(['dashboard', 'events', 'funnel']);

    // é¢„åŠ è½½å…³é”®è·¯ç”±
    preloadCriticalRoutes();
    ```

    #### 3.2.3 åœ¨ä¾§è¾¹æ ä¸­é›†æˆé¢„åŠ è½½

    å¯ä»¥åœ¨ `Sidebar.tsx` ä¸­æ·»åŠ é¼ æ ‡æ‚¬åœé¢„åŠ è½½ï¼š

    ```typescript
    import { preloadRoute } from '@/utils/routePreloader';

    const Sidebar = () => {
    // è·¯ç”±åç§°æ˜ å°„
    const routeMap: Record<string, string> = {
        '/app/dashboard': 'dashboard',
        '/app/events': 'events',
        '/app/funnel': 'funnel',
        // ... å…¶ä»–è·¯ç”±
    };

    // èœå•é¡¹æ‚¬åœæ—¶é¢„åŠ è½½
    const handleMenuHover = (key: string) => {
        const routeName = routeMap[key];
        if (routeName) {
        preloadRoute(routeName);
        }
    };

    return (
        <Menu
        onMouseEnter={(e) => handleMenuHover(e.key)}
        // ... å…¶ä»–é…ç½®
        />
    );
    };
    ```

    ### 3.3 èµ„æºé¢„å–ï¼ˆPrefetchï¼‰

    ä½¿ç”¨ `<link rel="prefetch">` åœ¨æµè§ˆå™¨ç©ºé—²æ—¶é¢„å–èµ„æºï¼š

    ```typescript
    // åœ¨ routePreloader.ts ä¸­å·²æä¾› prefetchRouteResource å‡½æ•°
    // æ³¨æ„ï¼šéœ€è¦çŸ¥é“æ„å»ºåçš„ chunk æ–‡ä»¶å
    ```

    **Vite è‡ªåŠ¨å¤„ç†ï¼š**
    - å¼€å‘ç¯å¢ƒï¼šVite ä¼šè‡ªåŠ¨ä¸ºåŠ¨æ€å¯¼å…¥æ·»åŠ  prefetch
    - ç”Ÿäº§ç¯å¢ƒï¼šå¯ä»¥é€šè¿‡åˆ†ææ„å»ºäº§ç‰©è·å– chunk åç§°

    ### 3.4 åŠ è½½çŠ¶æ€ä¼˜åŒ–

    #### 3.4.1 éª¨æ¶å±

    å¯ä»¥å°† `RouteLoading` ç»„ä»¶æ”¹ä¸ºéª¨æ¶å±ï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒï¼š

    ```typescript
    // ä½¿ç”¨ Skeleton ç»„ä»¶æ›¿ä»£ Spin
    import { Skeleton } from 'antd';

    const RouteLoading = () => (
    <div className="route-loading">
        <Skeleton active paragraph={{ rows: 8 }} />
    </div>
    );
    ```

    #### 3.4.2 æ¸è¿›å¼åŠ è½½

    å¯¹äºå¤§å‹é¡µé¢ï¼Œå¯ä»¥å…ˆåŠ è½½å…³é”®å†…å®¹ï¼Œå†åŠ è½½æ¬¡è¦å†…å®¹ï¼š

    ```typescript
    // åœ¨é¡µé¢ç»„ä»¶å†…éƒ¨ä¹Ÿå¯ä»¥ä½¿ç”¨ lazy
    const MainContent = lazy(() => import('./MainContent'));
    const Sidebar = lazy(() => import('./Sidebar'));
    ```

    ### 3.5 ç¼“å­˜ç­–ç•¥

    #### 3.5.1 HTTP ç¼“å­˜

    ç¡®ä¿æ„å»ºé…ç½®ä¸­çš„ chunk æ–‡ä»¶ååŒ…å« hashï¼š

    ```typescript
    chunkFileNames: 'js/[name]-[hash].js'
    ```

    **ä¼˜åŠ¿ï¼š**
    - å†…å®¹å˜åŒ–æ—¶ hash æ”¹å˜ï¼Œå¼ºåˆ¶æ›´æ–°
    - å†…å®¹æœªå˜åŒ–æ—¶ hash ä¸å˜ï¼Œåˆ©ç”¨æµè§ˆå™¨ç¼“å­˜

    #### 3.5.2 Service Worker ç¼“å­˜

    å¯ä»¥é›†æˆ Service Worker å®ç°æ›´ç²¾ç»†çš„ç¼“å­˜æ§åˆ¶ï¼š

    ```typescript
    // åœ¨ service worker ä¸­ç¼“å­˜è·¯ç”± chunk
    self.addEventListener('fetch', (event) => {
    if (event.request.url.includes('/js/')) {
        event.respondWith(
        caches.match(event.request).then((response) => {
            return response || fetch(event.request);
        })
        );
    }
    });
    ```

    ## å››ã€æ€§èƒ½ç›‘æ§

    ### 4.1 åŠ è½½æ—¶é—´ç›‘æ§

    å¯ä»¥ä½¿ç”¨ Performance API ç›‘æ§è·¯ç”±åŠ è½½æ—¶é—´ï¼š

    ```typescript
    // åœ¨è·¯ç”±ç»„ä»¶åŠ è½½æ—¶è®°å½•æ—¶é—´
    const startTime = performance.now();
    const module = await import('@/pages/Dashboard');
    const loadTime = performance.now() - startTime;

    console.log(`Dashboard åŠ è½½æ—¶é—´: ${loadTime}ms`);
    ```

    ### 4.2 é”™è¯¯ç›‘æ§

    åœ¨ `RouteErrorBoundary` ä¸­å·²ç»å®ç°äº†é”™è¯¯å¤„ç†ï¼Œå¯ä»¥é›†æˆé”™è¯¯ç›‘æ§æœåŠ¡ï¼š

    ```typescript
    // åœ¨ RouteErrorBoundary ä¸­
    if (error instanceof Error) {
    // å‘é€é”™è¯¯åˆ°ç›‘æ§æœåŠ¡
    errorTrackingService.captureException(error);
    }
    ```

    ## äº”ã€æœ€ä½³å®è·µæ€»ç»“

    ### âœ… å·²å®ç°

    1. âœ… æ‰€æœ‰è·¯ç”±ç»„ä»¶ä½¿ç”¨ `lazy()` æ‡’åŠ è½½
    2. âœ… ç»Ÿä¸€çš„ `Suspense` åŒ…è£…å’ŒåŠ è½½çŠ¶æ€
    3. âœ… é”™è¯¯è¾¹ç•Œå¤„ç†
    4. âœ… æ„å»ºæ—¶æ‰‹åŠ¨åˆ†åŒ…ä¼˜åŒ–
    5. âœ… Chunk æ–‡ä»¶ååŒ…å« hashï¼Œä¾¿äºç¼“å­˜

    ### ğŸ”„ å»ºè®®ä¼˜åŒ–

    1. **è·¯ç”±é¢„åŠ è½½**ï¼šåœ¨èœå•æ‚¬åœæ—¶é¢„åŠ è½½ï¼ˆå·²æä¾›å·¥å…·å‡½æ•°ï¼‰
    2. **éª¨æ¶å±**ï¼šä½¿ç”¨éª¨æ¶å±æ›¿ä»£ç®€å•çš„ Loading åŠ¨ç”»
    3. **å…³é”®è·¯ç”±é¢„åŠ è½½**ï¼šåº”ç”¨åˆå§‹åŒ–åé¢„åŠ è½½å¸¸ç”¨é¡µé¢
    4. **æ€§èƒ½ç›‘æ§**ï¼šæ·»åŠ è·¯ç”±åŠ è½½æ—¶é—´ç›‘æ§
    5. **æ¸è¿›å¼åŠ è½½**ï¼šå¤§å‹é¡µé¢å†…éƒ¨ä¹Ÿå¯ä»¥ä½¿ç”¨æ‡’åŠ è½½

    ### ğŸ“Š æ€§èƒ½æŒ‡æ ‡ç›®æ ‡

    - **é¦–æ¬¡å†…å®¹ç»˜åˆ¶ï¼ˆFCPï¼‰**ï¼š< 1.8s
    - **æœ€å¤§å†…å®¹ç»˜åˆ¶ï¼ˆLCPï¼‰**ï¼š< 2.5s
    - **è·¯ç”±åˆ‡æ¢æ—¶é—´**ï¼š< 300msï¼ˆå·²é¢„åŠ è½½ï¼‰
    - **è·¯ç”±åˆ‡æ¢æ—¶é—´**ï¼š< 1sï¼ˆæœªé¢„åŠ è½½ï¼‰

    ## å…­ã€ä½¿ç”¨ç¤ºä¾‹

    ### 6.1 åœ¨åº”ç”¨åˆå§‹åŒ–æ—¶é¢„åŠ è½½å…³é”®è·¯ç”±

    ```typescript
    // src/main.tsx
    import { preloadCriticalRoutes } from '@/utils/routePreloader';

    // åº”ç”¨æŒ‚è½½åé¢„åŠ è½½
    preloadCriticalRoutes();
    ```

    ### 6.2 åœ¨ä¾§è¾¹æ èœå•ä¸­é›†æˆé¢„åŠ è½½

    ```typescript
    // src/components/Sidebar.tsx
    import { preloadRoute } from '@/utils/routePreloader';

    const handleMenuHover = (key: string) => {
    const routeMap: Record<string, string> = {
        '/app/dashboard': 'dashboard',
        '/app/events': 'events',
        // ...
    };
    const routeName = routeMap[key];
    if (routeName) {
        preloadRoute(routeName);
    }
    };
    ```

    ### 6.3 æ ¹æ®ç”¨æˆ·è¡Œä¸ºæ™ºèƒ½é¢„åŠ è½½

    ```typescript
    // ç”¨æˆ·è®¿é—® dashboard åï¼Œé¢„åŠ è½½å¯èƒ½è®¿é—®çš„é¡µé¢
    if (currentRoute === 'dashboard') {
    preloadRoutes(['events', 'funnel', 'performance']);
    }
    ```

    ## ä¸ƒã€æ³¨æ„äº‹é¡¹

    1. **ä¸è¦è¿‡åº¦é¢„åŠ è½½**ï¼šé¢„åŠ è½½å¤ªå¤šè·¯ç”±ä¼šæµªè´¹å¸¦å®½å’Œèµ„æº
    2. **è€ƒè™‘ç½‘ç»œçŠ¶å†µ**ï¼šåœ¨æ…¢é€Ÿç½‘ç»œä¸‹ï¼Œé¢„åŠ è½½å¯èƒ½å½±å“å½“å‰é¡µé¢åŠ è½½
    3. **ç§»åŠ¨ç«¯ä¼˜åŒ–**ï¼šç§»åŠ¨ç«¯å¯ä»¥ç¦ç”¨é¢„åŠ è½½æˆ–ä½¿ç”¨æ›´ä¿å®ˆçš„ç­–ç•¥
    4. **é”™è¯¯å¤„ç†**ï¼šé¢„åŠ è½½å¤±è´¥ä¸åº”è¯¥å½±å“æ­£å¸¸çš„è·¯ç”±å¯¼èˆª

    ## å…«ã€æ€»ç»“

    è·¯ç”±æ‡’åŠ è½½æ˜¯æå‡åº”ç”¨æ€§èƒ½çš„é‡è¦æ‰‹æ®µï¼Œé€šè¿‡åˆç†çš„å®ç°å’Œä¼˜åŒ–ï¼Œå¯ä»¥æ˜¾è‘—æ”¹å–„ç”¨æˆ·ä½“éªŒã€‚å½“å‰é¡¹ç›®å·²ç»å®ç°äº†åŸºç¡€çš„æ‡’åŠ è½½åŠŸèƒ½ï¼Œå»ºè®®åœ¨æ­¤åŸºç¡€ä¸Šæ·»åŠ é¢„åŠ è½½ç­–ç•¥ï¼Œè¿›ä¸€æ­¥æå‡æ€§èƒ½ã€‚

