# 登录安全加密实现说明

## 📋 概述

为了提升登录安全性，实现了基于 RSA 的密码加密传输机制。密码在客户端使用 RSA 公钥加密后发送到服务器，服务器使用私钥解密，避免了密码在传输过程中的明文暴露。

## 🔐 安全改进

### 1. 传输加密
- **前端**：使用 RSA 公钥加密密码后发送
- **后端**：使用 RSA 私钥解密密码
- **优势**：即使 HTTP 请求被拦截，攻击者也无法获取明文密码（需要私钥才能解密）

### 2. 密码存储加密升级
- **旧方案**：MD5 哈希（不安全，已被破解）
- **新方案**：SHA-256 + Salt（更安全）
- **兼容性**：支持验证旧格式的 MD5 密码，新注册用户自动使用新格式

### 3. 密钥管理
- RSA 密钥对自动生成和管理
- 公钥通过 API 提供给前端
- 私钥仅存储在服务器，权限设置为 600（仅所有者可读写）

## 🛠️ 技术实现

### 前端加密流程

```typescript
// 1. 获取 RSA 公钥（自动缓存）
const publicKey = await getPublicKey();

// 2. 加密密码
const encryptedPassword = await encryptPassword(password);

// 3. 发送加密后的密码
await apiService.login({ username, password: encryptedPassword });
```

### 后端解密流程

```typescript
// 1. 中间件自动解密密码
decryptPasswordMiddleware -> 解密 req.body.password

// 2. 验证密码（兼容新旧格式）
verifyPassword(明文密码, 数据库中的哈希值)

// 3. 登录成功，返回 JWT Token
```

## 📁 文件结构

### 前端文件
- `src/utils/crypto.ts` - RSA 加密工具
- `src/pages/login/index.tsx` - 登录页面（已集成加密）
- `src/pages/register/index.tsx` - 注册页面（已集成加密）

### 后端文件
- `server/src/utils/crypto.ts` - RSA 密钥管理和密码哈希工具
- `server/src/routes/api.ts` - 路由（公钥接口、解密中间件）
- `server/src/services/userService.ts` - 用户服务（密码验证）

### 密钥文件
- `server/keys/public.pem` - RSA 公钥（自动生成）
- `server/keys/private.pem` - RSA 私钥（自动生成，不提交到版本控制）

## 🚀 部署说明

### 自动生成密钥

首次启动服务器时，系统会自动生成 RSA 密钥对：
- 密钥存储在 `server/keys/` 目录
- 私钥文件权限自动设置为 600
- 如果密钥文件已存在，将使用现有密钥

### 手动生成密钥

如果需要手动生成或替换密钥：

```bash
cd server
mkdir -p keys

# 生成私钥
openssl genrsa -out keys/private.pem 2048

# 导出公钥
openssl rsa -in keys/private.pem -pubout -out keys/public.pem

# 设置权限
chmod 600 keys/private.pem
chmod 644 keys/public.pem
```

### 生产环境建议

1. **密钥安全**：
   - 定期轮换密钥对
   - 使用密钥管理服务（如 AWS KMS、Azure Key Vault）
   - 不要将私钥提交到版本控制

2. **HTTPS 强制**：
   - 即使有 RSA 加密，也应使用 HTTPS
   - 配置 HSTS 强制 HTTPS
   - 使用有效的 SSL 证书

3. **密码策略**：
   - 要求强密码（至少 8 位，包含大小写字母、数字、特殊字符）
   - 实施密码复杂度检查
   - 考虑添加双因素认证（2FA）

## 🔄 兼容性

### 向后兼容

- **旧密码**：系统仍能验证使用 MD5 哈希的旧密码
- **旧客户端**：后端中间件允许明文密码（带警告），确保旧版本客户端仍可登录

### 迁移建议

1. **用户迁移**：
   - 用户下次登录时，密码会以新格式验证
   - 建议用户在下次登录后更改密码，自动升级到新格式

2. **批量迁移脚本**：
   ```sql
   -- 注意：这个脚本仅作示例，实际使用时需要配合应用层逻辑
   -- 不要直接更新密码哈希，应由用户重新设置密码
   ```

## 📊 安全等级提升

| 项目 | 改进前 | 改进后 |
|------|--------|--------|
| 传输加密 | 无（明文或 HTTPS） | RSA-2048 加密 + HTTPS |
| 密码哈希 | MD5（不安全） | SHA-256 + Salt |
| 密钥管理 | 无 | 自动生成和管理 |
| 兼容性 | - | 支持旧格式密码 |

## ⚠️ 注意事项

1. **密钥泄露**：如果私钥泄露，应立即重新生成密钥对并通知用户更改密码
2. **密码长度限制**：RSA-2048 密钥最多加密 190 字节，密码长度不应超过此限制
3. **性能影响**：RSA 加密/解密有一定性能开销，但通常可忽略（毫秒级）
4. **浏览器兼容性**：Web Crypto API 需要现代浏览器支持（IE 不支持）

## 🔍 测试验证

### 测试加密流程

1. 打开浏览器开发者工具
2. 进入登录页面
3. 查看 Network 标签
4. 提交登录请求
5. 验证请求体中的 `password` 字段是 Base64 编码的加密字符串（不是明文）

### 测试兼容性

1. 使用旧版本客户端登录（如果存在）
2. 验证仍能正常登录
3. 检查服务器日志中的警告信息

## 📚 参考资源

- [Web Crypto API](https://developer.mozilla.org/en-US/docs/Web/API/Web_Crypto_API)
- [RSA 加密算法](https://en.wikipedia.org/wiki/RSA_(cryptosystem))
- [OWASP 密码存储指南](https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html)

## 🔄 后续改进建议

1. **升级到 bcrypt**：虽然当前使用 SHA-256 + Salt 已比 MD5 安全，但 bcrypt 更适合密码存储（计算成本可调）
2. **添加密钥轮换机制**：定期更换密钥对
3. **实施速率限制**：防止暴力破解攻击
4. **添加双因素认证**：进一步提升安全性
5. **密码强度检查**：前端和后端双重验证

