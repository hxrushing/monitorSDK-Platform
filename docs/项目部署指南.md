# 项目部署指南

本指南将帮助您将完整的分析平台项目部署到生产环境。项目包含前端、后端API服务、ML服务和MySQL数据库。

## 📋 目录

1. [部署架构概览](#部署架构概览)
2. [快速开始](#快速开始)
   - [方式一：Docker Compose 部署（推荐）](#方式一docker-compose-部署推荐)
   - [方式二：传统方式部署](#方式二传统方式部署)
3. [前置准备](#前置准备)
4. [数据库部署](#数据库部署)
5. [后端服务部署](#后端服务部署)
6. [ML服务部署](#ml服务部署)
7. [前端部署](#前端部署)
8. [Nginx反向代理配置](#nginx反向代理配置)
9. [环境变量配置](#环境变量配置)
10. [部署验证](#部署验证)
11. [常见问题](#常见问题)

---

## 部署架构概览

```
用户浏览器
    ↓
Nginx (反向代理 + 静态文件服务)
    ↓
    ├─→ 前端静态文件 (dist/)
    └─→ 后端API (/api/*) → Node.js服务 (端口 3000)
                    ↓
                    ├─→ MySQL数据库 (端口 3306)
                    └─→ ML服务 (端口 5000)
```

---

## 快速开始

### 方式一：Docker Compose 部署（推荐）

这是最简单的部署方式，适合快速部署和开发环境。

#### 1. 安装 Docker 和 Docker Compose

```bash
# 安装Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 安装Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 验证安装
docker --version
docker-compose --version
```

#### 2. 配置环境变量

```bash
# 复制环境变量模板
cp server/.env.example server/.env
cp ml-service/.env.example ml-service/.env

# 编辑环境变量文件
nano server/.env  # 填入实际配置
```

#### 3. 启动所有服务

```bash
# 启动所有服务（包括数据库、后端、ML服务、前端）
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down

# 停止并删除数据卷（注意：会删除数据库数据）
docker-compose down -v
```

#### 4. 初始化数据库

```bash
# 进入后端容器
docker-compose exec backend sh

# 在容器内执行
cd /app
pnpm run init-db

# 或直接执行
docker-compose exec backend node dist/init-database.js
```

#### 5. 访问应用

- 前端: http://localhost
- API文档: http://localhost/api/docs
- 后端API: http://localhost/api

#### Docker 部署优势

- ✅ 一键启动所有服务
- ✅ 环境隔离，依赖清晰
- ✅ 易于扩展和维护
- ✅ 适合生产环境（配合Docker Swarm或Kubernetes）

---

### 方式二：传统方式部署

如果您不想使用Docker，可以按照以下步骤手动部署各个服务。

---

## 前置准备

### 1. 服务器要求

- **操作系统**: Linux (推荐 Ubuntu 20.04+ 或 CentOS 7+)
- **Node.js**: v18.0.0 或更高版本
- **Python**: 3.8+ (ML服务)
- **MySQL**: 8.0+
- **Nginx**: 1.18+
- **内存**: 建议至少 4GB
- **存储**: 建议至少 20GB

### 2. 安装必要工具

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装 Node.js (使用 nvm 推荐)
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 18
nvm use 18

# 安装 pnpm
npm install -g pnpm

# 安装 Python 和 pip
sudo apt install python3 python3-pip python3-venv -y

# 安装 MySQL
sudo apt install mysql-server -y

# 安装 Nginx
sudo apt install nginx -y

# 安装 PM2 (进程管理器)
npm install -g pm2
```

---

## 数据库部署

### 1. 配置MySQL

```bash
# 启动MySQL服务
sudo systemctl start mysql
sudo systemctl enable mysql

# 安全配置
sudo mysql_secure_installation
```

### 2. 创建数据库和用户

```bash
# 登录MySQL
sudo mysql -u root -p

# 在MySQL中执行
CREATE DATABASE analytics_platform CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'analytics_user'@'localhost' IDENTIFIED BY 'your_secure_password';
GRANT ALL PRIVILEGES ON analytics_platform.* TO 'analytics_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

### 3. 初始化数据库表结构

```bash
# 进入server目录
cd server

# 创建 .env 文件（见下方环境变量配置）
# 然后初始化数据库
pnpm install
pnpm run init-db
```

---

## 后端服务部署

### 1. 部署步骤

```bash
# 克隆或上传项目到服务器
cd /var/www/sdk-platform  # 或您的项目目录

# 安装依赖
cd server
pnpm install

# 构建TypeScript
pnpm run build

# 配置环境变量（见下方）
# 创建 .env 文件

# 使用PM2启动服务
pm2 start dist/app.js --name analytics-api

# 设置开机自启
pm2 startup
pm2 save
```

### 2. PM2常用命令

```bash
# 查看状态
pm2 status

# 查看日志
pm2 logs analytics-api

# 重启服务
pm2 restart analytics-api

# 停止服务
pm2 stop analytics-api

# 删除服务
pm2 delete analytics-api
```

---

## ML服务部署

### 1. 部署步骤

```bash
# 进入ML服务目录
cd ml-service

# 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 配置环境变量（可选，默认端口5000）
# 创建 .env 文件

# 使用PM2启动（需要安装 pm2-logrotate）
npm install -g pm2-logrotate

# 启动ML服务
pm2 start app.py --name ml-service --interpreter python3

# 或使用 gunicorn 生产环境部署（推荐）
pip install gunicorn
pm2 start "gunicorn -w 4 -b 0.0.0.0:5000 app:app" --name ml-service

# 设置开机自启
pm2 save
```

### 2. ML服务环境变量（可选）

在 `ml-service/.env` 中配置：

```env
ML_SERVICE_PORT=5000
FLASK_DEBUG=False
```

---

## 前端部署

### 1. 构建前端

```bash
# 进入项目根目录
cd /var/www/sdk-platform

# 安装依赖
pnpm install

# 构建生产版本
pnpm run build

# 构建产物在 dist/ 目录
```

### 2. 配置生产环境API地址

在构建前，需要修改前端代码中的API地址，或者通过环境变量注入。

**方式1：修改 `vite.config.ts`** 添加生产环境配置

```typescript
export default defineConfig({
  // ... 其他配置
  define: {
    'import.meta.env.VITE_API_URL': JSON.stringify(process.env.VITE_API_URL || 'https://api.yourdomain.com'),
  },
})
```

**方式2：在 `src/services/api.ts` 中使用环境变量**

```typescript
const API_BASE_URL = import.meta.env.VITE_API_URL || '/api';
```

### 3. 部署静态文件

构建完成后，`dist/` 目录包含所有静态文件，可以通过Nginx直接提供服务（见下方Nginx配置）。

---

## Nginx反向代理配置

### 1. 创建Nginx配置

创建配置文件 `/etc/nginx/sites-available/analytics-platform`:

```nginx
server {
    listen 80;
    server_name yourdomain.com;  # 替换为您的域名

    # 前端静态文件
    root /var/www/sdk-platform/dist;
    index index.html;

    # 前端路由（SPA支持）
    location / {
        try_files $uri $uri/ /index.html;
        
        # 缓存配置
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # 后端API代理
    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # 超时配置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # API文档
    location /api/docs {
        proxy_pass http://localhost:3000/api/docs;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json application/javascript;

    # 安全头
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
}
```

### 2. 启用配置

```bash
# 创建符号链接
sudo ln -s /etc/nginx/sites-available/analytics-platform /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx
sudo systemctl enable nginx
```

### 3. 配置HTTPS (可选但推荐)

使用 Let's Encrypt 免费SSL证书：

```bash
# 安装 Certbot
sudo apt install certbot python3-certbot-nginx -y

# 获取证书
sudo certbot --nginx -d yourdomain.com

# 自动续期测试
sudo certbot renew --dry-run
```

---

## 环境变量配置

### 1. 后端环境变量 (`server/.env`)

```env
# 服务端口
PORT=3000
NODE_ENV=production

# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_USER=analytics_user
DB_PASSWORD=your_secure_password
DB_NAME=analytics_platform
DB_POOL_LIMIT=20

# JWT配置
JWT_SECRET=your_jwt_secret_key_change_in_production
JWT_EXPIRES_IN=7d

# OpenAI配置
OPENAI_API_KEY=sk-your-openai-api-key
OPENAI_BASE_URL=https://api.openai.com/v1
OPENAI_MODEL=gpt-3.5-turbo
OPENAI_TIMEOUT_MS=120000

# AI服务配置
AI_MAX_PROJECTS=50
AI_MAX_PROJECTS_PER_BATCH=10
AI_MAX_PROMPT_TOKENS=3000

# ML服务地址
ML_SERVICE_URL=http://localhost:5000

# 邮件服务配置（可选）
SMTP_HOST=smtp.qq.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your_email@qq.com
SMTP_PASSWORD=your_email_password
SMTP_FROM=your_email@qq.com
SMTP_DEBUG=false
```

### 2. ML服务环境变量 (`ml-service/.env`)

```env
ML_SERVICE_PORT=5000
FLASK_DEBUG=False
```

### 3. 前端环境变量（构建时）

在项目根目录创建 `.env.production`:

```env
VITE_API_URL=https://api.yourdomain.com
```

⚠️ **安全提示**: 
- 不要将 `.env` 文件提交到Git仓库
- 生产环境使用强密码和安全的密钥
- 定期轮换密钥和密码

---

## 部署验证

### 1. 检查服务状态

```bash
# 检查PM2进程
pm2 status

# 检查Nginx状态
sudo systemctl status nginx

# 检查MySQL状态
sudo systemctl status mysql

# 检查端口占用
sudo netstat -tlnp | grep -E ':(3000|5000|80|443|3306)'
```

### 2. 测试API

```bash
# 测试后端API
curl http://localhost:3000/api/health  # 如果有健康检查端点

# 测试ML服务
curl http://localhost:5000/health  # 如果有健康检查端点

# 测试前端访问
curl http://localhost/
```

### 3. 浏览器访问

1. 访问 `http://yourdomain.com` 或 `https://yourdomain.com`
2. 检查前端页面是否正常加载
3. 测试API调用是否正常
4. 检查浏览器控制台是否有错误

---

## 常见问题

### 1. 数据库连接失败

**问题**: 后端无法连接到MySQL

**解决方案**:
- 检查MySQL服务是否运行: `sudo systemctl status mysql`
- 验证数据库用户权限
- 检查防火墙是否开放3306端口
- 确认 `.env` 文件中的数据库配置正确

### 2. CORS错误

**问题**: 前端请求API时出现CORS错误

**解决方案**:
- 在后端 `app.ts` 中配置正确的 `origin`
- 确保Nginx代理配置正确
- 检查请求头配置

### 3. ML服务启动失败

**问题**: ML服务无法启动，提示TensorFlow或其他依赖错误

**解决方案**:
- 确保Python版本 >= 3.8
- 检查虚拟环境是否正确激活
- 重新安装依赖: `pip install -r requirements.txt`
- 如果TensorFlow安装失败，可以考虑使用CPU版本或简化版本

### 4. 静态资源404

**问题**: 前端JS/CSS文件404

**解决方案**:
- 检查 `dist/` 目录是否存在且包含构建产物
- 检查Nginx配置中的 `root` 路径是否正确
- 检查文件权限: `sudo chown -R www-data:www-data /var/www/sdk-platform/dist`

### 5. PM2服务无法自动启动

**问题**: 服务器重启后PM2服务未自动启动

**解决方案**:
```bash
# 重新设置PM2开机自启
pm2 unstartup
pm2 startup
pm2 save
```

### 6. 内存不足

**问题**: 服务器内存使用过高

**解决方案**:
- 调整MySQL连接池大小（`DB_POOL_LIMIT`）
- 调整PM2实例数
- 考虑使用内存缓存（Redis）
- 增加服务器内存

### 7. API响应慢

**问题**: API请求响应时间过长

**解决方案**:
- 检查数据库查询是否优化（添加索引）
- 检查Nginx和Node.js的日志
- 考虑添加Redis缓存
- 优化数据库查询语句

---

## 部署清单

部署前检查：

- [ ] 服务器环境准备完成（Node.js, Python, MySQL, Nginx）
- [ ] 数据库创建并初始化
- [ ] 后端环境变量配置完成
- [ ] 后端服务启动并运行正常
- [ ] ML服务启动并运行正常
- [ ] 前端构建完成
- [ ] Nginx配置完成并生效
- [ ] 域名DNS解析配置完成
- [ ] SSL证书配置完成（如使用HTTPS）
- [ ] 防火墙规则配置完成
- [ ] 所有服务设置为开机自启
- [ ] 日志监控配置完成

---

## 部署脚本使用

项目提供了自动化部署脚本 `deploy.sh`，可以简化部署流程：

```bash
# 给脚本添加执行权限
chmod +x deploy.sh

# 运行部署脚本
bash deploy.sh production

# 或在开发环境
bash deploy.sh dev
```

脚本会自动完成：
- ✅ 前端构建
- ✅ 后端构建
- ✅ 数据库初始化（可选）
- ✅ 启动后端服务（PM2）
- ✅ 启动ML服务（PM2）
- ✅ Nginx配置检查

---

## 后续优化建议

1. **监控和日志**
   - 使用PM2日志管理: `pm2 install pm2-logrotate`
   - 配置日志收集系统（如ELK Stack）
   - 添加应用性能监控（APM）

2. **备份策略**
   - 定期备份MySQL数据库
   - 配置自动备份脚本
   - 测试备份恢复流程

3. **性能优化**
   - 配置CDN加速静态资源
   - 使用Redis缓存热点数据
   - 数据库读写分离
   - 负载均衡（多实例部署）

4. **安全加固**
   - 配置防火墙规则
   - 定期更新系统依赖
   - 使用强密码策略
   - 配置DDoS防护

5. **CI/CD自动化**
   - 配置GitHub Actions或GitLab CI
   - 自动化测试和部署流程
   - 蓝绿部署或滚动更新

---

## 联系支持

如有问题，请检查：
1. 服务日志: `pm2 logs`
2. Nginx日志: `/var/log/nginx/error.log`
3. MySQL日志: `/var/log/mysql/error.log`

祝部署顺利！🎉

