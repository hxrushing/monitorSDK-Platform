# æ¢é’ˆæ¨¡å—å®ç°æ€»ç»“

## âœ… å·²å®Œæˆçš„æ¢é’ˆæ¨¡å—

### 1. é”™è¯¯æ¢é’ˆ (ErrorProbe) âœ…

**æ–‡ä»¶**: `src/sdk/probes/error/index.ts`

**åŠŸèƒ½**:
- âœ… JS Errorç›‘å¬
- âœ… Promise rejectionç›‘å¬
- âœ… èµ„æºåŠ è½½é”™è¯¯ç›‘å¬ï¼ˆIMG/SCRIPT/LINKï¼‰
- âš ï¸ consoleé‡å†™ï¼ˆå·²å®ç°ä½†é»˜è®¤å…³é—­ï¼Œé¿å…å½±å“è°ƒè¯•ï¼‰

**ä½¿ç”¨æ–¹å¼**:
```typescript
// SDKåˆå§‹åŒ–æ—¶è‡ªåŠ¨åŠ è½½ï¼ˆå¦‚æœå¯ç”¨ï¼‰
const sdk = init({
  enable: {
    error: true,  // å¯ç”¨é”™è¯¯æ¢é’ˆ
  },
});
```

### 2. HTTPæ¢é’ˆ (HttpProbe) âœ…

**æ–‡ä»¶**: `src/sdk/probes/http/index.ts`

**åŠŸèƒ½**:
- âœ… Fetch APIæ‹¦æˆª
- âœ… XMLHttpRequestæ‹¦æˆª
- âœ… URLè¿‡æ»¤ï¼ˆæ”¯æŒå­—ç¬¦ä¸²å’Œæ­£åˆ™è¡¨è¾¾å¼ï¼‰
- âœ… è¯·æ±‚å¤´è„±æ•ï¼ˆmaskHeadersï¼‰
- âœ… è¯·æ±‚ä½“è„±æ•ï¼ˆmaskBodyKeysï¼‰
- âœ… è¯·æ±‚/å“åº”å¤§å°ç»Ÿè®¡
- âœ… è¯·æ±‚æ—¶é•¿ç»Ÿè®¡
- âœ… é”™è¯¯è¯·æ±‚ä¸ŠæŠ¥

**é…ç½®ç¤ºä¾‹**:
```typescript
const sdk = init({
  enable: {
    http: true,
  },
  http: {
    ignoreUrls: [/\.map$/, /health/],  // å¿½ç•¥çš„URL
    maskHeaders: ['Authorization', 'Cookie'],  // è„±æ•çš„è¯·æ±‚å¤´
    maskBodyKeys: ['password', 'token'],  // è„±æ•çš„è¯·æ±‚ä½“å­—æ®µ
    includeRequestBody: false,  // æ˜¯å¦åŒ…å«è¯·æ±‚ä½“
    includeResponseBody: false,  // æ˜¯å¦åŒ…å«å“åº”ä½“
    maxBodySize: 10 * 1024,  // æœ€å¤§bodyå¤§å°ï¼ˆ10KBï¼‰
  },
});
```

**æ³¨æ„**:
- XHRè¯·æ±‚å¤´æ— æ³•è·å–ï¼ˆæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼‰ï¼Œåªè®°å½•å“åº”å¤´
- Fetchè¯·æ±‚å¯ä»¥è·å–è¯·æ±‚å¤´å’Œå“åº”å¤´

### 3. æ€§èƒ½æ¢é’ˆ (PerformanceProbe) âœ…

**æ–‡ä»¶**: `src/sdk/probes/performance/index.ts`

**åŠŸèƒ½**:
- âœ… Web VitalsæŒ‡æ ‡é‡‡é›†ï¼ˆFCP/LCP/CLS/TTFB/INPï¼‰
- âœ… é•¿ä»»åŠ¡ç›‘æ§ï¼ˆLong Taskï¼‰
- âœ… é‡‡æ ·ç‡æ§åˆ¶
- âœ… åŠ¨æ€å¯¼å…¥web-vitalsï¼ˆé¿å…å¢åŠ åˆå§‹bundleå¤§å°ï¼‰

**é…ç½®ç¤ºä¾‹**:
```typescript
const sdk = init({
  enable: {
    perf: true,
  },
  sampleRate: {
    perf: 1.0,        // æ€§èƒ½æŒ‡æ ‡100%é‡‡æ ·
    longTask: 0.3,    // é•¿ä»»åŠ¡30%é‡‡æ ·
  },
});
```

**é‡‡é›†çš„æŒ‡æ ‡**:
- `FCP` - First Contentful Paint
- `LCP` - Largest Contentful Paint
- `CLS` - Cumulative Layout Shift
- `TTFB` - Time to First Byte
- `INP` - Interaction to Next Paintï¼ˆæ›¿ä»£FIDï¼‰
- `long-task` - è¶…è¿‡50msçš„é•¿ä»»åŠ¡

### 4. è¡Œä¸ºæ¢é’ˆ (BehaviorProbe) âœ…

**æ–‡ä»¶**: `src/sdk/probes/behavior/index.ts`

**åŠŸèƒ½**:
- âœ… è‡ªåŠ¨PVä¸ŠæŠ¥
- âœ… è·¯ç”±åˆ‡æ¢ç›‘å¬ï¼ˆpopstate/pushState/replaceState/hashchangeï¼‰
- âœ… é¡µé¢åœç•™æ—¶é•¿ç»Ÿè®¡
- âœ… ç‚¹å‡»äº‹ä»¶é‡‡é›†ï¼ˆå¯é€‰ï¼‰
- âœ… é¡µé¢å¯è§æ€§ç›‘å¬

**é…ç½®ç¤ºä¾‹**:
```typescript
const sdk = init({
  enable: {
    behavior: true,
  },
  behavior: {
    autoPV: true,        // è‡ªåŠ¨PVä¸ŠæŠ¥
    autoRoute: true,     // è‡ªåŠ¨è·¯ç”±åˆ‡æ¢ç›‘å¬
    trackClick: false,   // ç‚¹å‡»äº‹ä»¶é‡‡é›†ï¼ˆé»˜è®¤å…³é—­ï¼Œé¿å…äº§ç”Ÿè¿‡å¤šäº‹ä»¶ï¼‰
    trackExposure: false, // æ›å…‰äº‹ä»¶é‡‡é›†ï¼ˆæš‚æœªå®ç°ï¼‰
    sessionTimeout: 30 * 60 * 1000,  // ä¼šè¯è¶…æ—¶30åˆ†é’Ÿ
  },
});
```

**è·¯ç”±ç›‘å¬æ”¯æŒ**:
- âœ… History API (pushState/replaceState)
- âœ… PopStateäº‹ä»¶ï¼ˆæµè§ˆå™¨å‰è¿›åé€€ï¼‰
- âœ… HashChangeäº‹ä»¶ï¼ˆhashè·¯ç”±ï¼‰

## ğŸ“¦ æ¢é’ˆè‡ªåŠ¨åŠ è½½æœºåˆ¶

æ‰€æœ‰æ¢é’ˆåœ¨SDKåˆå§‹åŒ–æ—¶æ ¹æ®é…ç½®è‡ªåŠ¨åŠ è½½ï¼š

```typescript
// src/sdk/core/api/index.ts
private initProbes(): void {
  // æ ¹æ®é…ç½®åŠ¨æ€åŠ è½½æ¢é’ˆ
  if (this.config.enable.error) {
    import('../../probes/error').then(({ ErrorProbe }) => {
      // åŠ è½½é”™è¯¯æ¢é’ˆ
    });
  }
  
  if (this.config.enable.http) {
    import('../../probes/http').then(({ HttpProbe }) => {
      // åŠ è½½HTTPæ¢é’ˆ
    });
  }
  
  // ... å…¶ä»–æ¢é’ˆ
}
```

## ğŸ”§ æ¢é’ˆæ¥å£è§„èŒƒ

æ‰€æœ‰æ¢é’ˆéƒ½å®ç° `Probe` æ¥å£ï¼š

```typescript
interface Probe {
  name: string;                    // æ¢é’ˆåç§°
  enabled: boolean;                // æ˜¯å¦å¯ç”¨
  init(reporter: EventReporter): void;  // åˆå§‹åŒ–
  destroy(): void;                 // é”€æ¯
}
```

## ğŸ“Š äº‹ä»¶ä¸ŠæŠ¥æ ¼å¼

### é”™è¯¯äº‹ä»¶
```typescript
{
  eventType: 'error',
  payload: {
    errorType: 'js' | 'promise' | 'resource',
    message: string,
    stack?: string,
    // ... å…¶ä»–é”™è¯¯ä¿¡æ¯
  }
}
```

### HTTPäº‹ä»¶
```typescript
{
  eventType: 'http',
  payload: {
    url: string,
    method: string,
    status: number,
    duration: number,
    requestSize?: number,
    responseSize?: number,
    requestHeaders?: Record<string, string>,
    responseHeaders?: Record<string, string>,
  }
}
```

### æ€§èƒ½äº‹ä»¶
```typescript
{
  eventType: 'perf',
  payload: {
    metric: 'FCP' | 'LCP' | 'CLS' | 'TTFB' | 'INP' | 'long-task',
    value: number,
    rating?: 'good' | 'needs-improvement' | 'poor',
    // ... å…¶ä»–æŒ‡æ ‡ä¿¡æ¯
  }
}
```

### é¡µé¢æµè§ˆäº‹ä»¶
```typescript
{
  eventType: 'page_view',
  payload: {
    path: string,
    title?: string,
    referrer?: string,
    stayDuration?: number,
  }
}
```

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### å®Œæ•´é…ç½®ç¤ºä¾‹

```typescript
import { init } from './sdk';

const sdk = init({
  projectId: 'demo-project',
  endpoint: 'http://localhost:3000/api/track',
  
  // å¯ç”¨æ¢é’ˆ
  enable: {
    error: true,        // é”™è¯¯ç›‘æ§
    http: true,         // HTTPç›‘æ§
    perf: true,         // æ€§èƒ½ç›‘æ§
    behavior: true,     // è¡Œä¸ºç›‘æ§
    blankScreen: false, // ç™½å±æ£€æµ‹ï¼ˆæš‚æœªå®ç°ï¼‰
  },
  
  // é‡‡æ ·ç‡é…ç½®
  sampleRate: {
    perf: 1.0,          // æ€§èƒ½100%é‡‡æ ·
    longTask: 0.3,      // é•¿ä»»åŠ¡30%é‡‡æ ·
    http: 1.0,          // HTTP100%é‡‡æ ·
    error: 1.0,         // é”™è¯¯100%é‡‡æ ·
    behavior: 1.0,      // è¡Œä¸º100%é‡‡æ ·
  },
  
  // HTTPæ¢é’ˆé…ç½®
  http: {
    ignoreUrls: [/\.map$/, /health/],
    maskHeaders: ['Authorization', 'Cookie'],
    maskBodyKeys: ['password', 'token'],
    includeRequestBody: false,
    includeResponseBody: false,
  },
  
  // è¡Œä¸ºæ¢é’ˆé…ç½®
  behavior: {
    autoPV: true,
    autoRoute: true,
    trackClick: false,
  },
  
  debug: true,  // å¯ç”¨è°ƒè¯•æ¨¡å¼
});
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ¢é’ˆåŠ è½½**: æ¢é’ˆé‡‡ç”¨åŠ¨æ€å¯¼å…¥ï¼Œé¿å…å¢åŠ åˆå§‹bundleå¤§å°
2. **é‡‡æ ·ç‡**: åˆç†è®¾ç½®é‡‡æ ·ç‡ï¼Œé¿å…äº§ç”Ÿè¿‡å¤šäº‹ä»¶
3. **éšç§ä¿æŠ¤**: HTTPæ¢é’ˆä¼šè„±æ•æ•æ„Ÿä¿¡æ¯ï¼Œä½†å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒè°¨æ…ä½¿ç”¨
4. **æ€§èƒ½å½±å“**: æ¢é’ˆä¼šæ‹¦æˆªåŸç”ŸAPIï¼ˆFetch/XHRï¼‰ï¼Œä½†å½±å“å¾ˆå°
5. **æµè§ˆå™¨å…¼å®¹**: 
   - Fetchæ‹¦æˆªï¼šç°ä»£æµè§ˆå™¨æ”¯æŒ
   - XHRæ‹¦æˆªï¼šæ‰€æœ‰æµè§ˆå™¨æ”¯æŒ
   - Long Taskï¼šéœ€è¦æµè§ˆå™¨æ”¯æŒPerformanceObserverå’Œlongtaskç±»å‹
   - Web Vitalsï¼šéœ€è¦æµè§ˆå™¨æ”¯æŒç›¸å…³API

## ğŸ“ åç»­è®¡åˆ’

### P2é˜¶æ®µä¼˜åŒ–
- [ ] ç™½å±æ£€æµ‹æ¢é’ˆ
- [ ] èµ„æºåŠ è½½æ¢é’ˆ
- [ ] æ›å…‰äº‹ä»¶é‡‡é›†
- [ ] Sessionå…³è”

### P3é˜¶æ®µå¢å¼º
- [ ] å½•å±/å›æ”¾èƒ½åŠ›
- [ ] é«˜çº§æ€§èƒ½æŒ‡æ ‡
- [ ] å‘Šè­¦ä¸Webhook
- [ ] å¯è§†åŒ–çœ‹æ¿å¯¹æ¥

