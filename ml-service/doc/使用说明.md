# 时序预测功能使用说明

## 功能概述

本功能使用LSTM和GRU深度学习模型，对PV、UV、转化率等指标进行未来1-7天的时序预测。

## 快速开始

### 1. 安装Python依赖

```bash
cd ml-service
pip install -r requirements.txt
```

**注意**：如果安装TensorFlow遇到问题，可以使用CPU版本：
```bash
pip install tensorflow-cpu==2.13.0
```

### 2. 配置环境变量（可选）

创建 `.env` 文件：
```env
ML_SERVICE_PORT=5000
FLASK_DEBUG=False
```

### 3. 启动ML预测服务

```bash
python app.py
```

服务将在 `http://localhost:5000` 启动。

**注意**：如果看到警告信息 "This is a development server"，这是正常的，可以忽略。代码已经优化，会自动隐藏这些警告。

### 3.1 测试服务是否正常（可选）

在另一个终端运行测试脚本：

```bash
python test_service.py
```

这将测试服务是否正常运行以及预测功能是否正常。

### 4. 配置后端服务

在 `server/.env` 文件中添加（如果ML服务不在默认地址）：
```env
ML_SERVICE_URL=http://localhost:5000
```

### 5. 启动后端服务

```bash
cd server
pnpm install  # 确保安装了axios
pnpm run dev
```

### 6. 使用前端界面

1. 登录系统
2. 在侧边栏点击"时序预测"
3. 选择要预测的指标（PV、UV或转化率）
4. 选择预测模型（LSTM或GRU）
5. 设置预测天数（1-30天）
6. 点击"预测单个指标"或"批量预测"

## 功能特性

### 支持的预测指标
- **PV（页面访问量）**：预测未来N天的页面访问次数
- **UV（独立访客）**：预测未来N天的独立访客数
- **转化率**：预测未来N天的UV/PV转化率

### 支持的模型
- **LSTM（长短期记忆网络）**：适合捕捉长期依赖关系
- **GRU（门控循环单元）**：计算效率更高，适合快速预测

### 数据要求
- 至少需要14天的历史数据才能进行预测
- 建议使用30天以上的历史数据以获得更好的预测效果

## API接口说明

### 健康检查
```bash
GET http://localhost:5000/health
```

### 单指标预测
```bash
POST http://localhost:5000/predict
Content-Type: application/json

{
  "projectId": "project-123",
  "metricType": "pv",
  "modelType": "lstm",
  "days": 7,
  "historicalData": [
    {"date": "2024-01-01", "pv": 1000, "uv": 500},
    ...
  ]
}
```

### 批量预测
```bash
POST http://localhost:5000/predict/batch
Content-Type: application/json

{
  "projectId": "project-123",
  "metrics": ["pv", "uv", "conversion_rate"],
  "modelType": "lstm",
  "days": 7,
  "historicalData": [...]
}
```

## 注意事项

1. **TensorFlow依赖**：如果未安装TensorFlow，系统会自动降级到线性回归模型
2. **首次预测**：首次预测需要训练模型，可能需要几秒钟时间
3. **数据质量**：预测准确性很大程度上取决于历史数据的质量和数量
4. **服务可用性**：前端会显示ML服务的连接状态，如果服务不可用会给出提示

## 故障排查

### ML服务无法连接
- 检查服务是否已启动：`curl http://localhost:5000/health`
- 检查端口是否被占用
- 检查防火墙设置

### 预测失败
- 确保有足够的历史数据（至少14天）
- 检查数据格式是否正确
- 查看服务日志了解详细错误信息

### TensorFlow安装问题
- 如果GPU版本安装失败，使用CPU版本：`pip install tensorflow-cpu`
- 确保Python版本 >= 3.8
- 在Windows上可能需要安装Visual C++ Redistributable

## 性能优化建议

1. **数据预处理**：确保历史数据连续，没有缺失值
2. **模型选择**：GRU模型训练速度更快，LSTM模型可能更准确
3. **预测天数**：预测天数越少，准确性通常越高
4. **历史数据量**：使用更多历史数据（30-60天）可以提高预测准确性

