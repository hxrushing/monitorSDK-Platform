# SDK 性能测试指南

## 📋 目录

1. [测试概述](#测试概述)
2. [测试环境准备](#测试环境准备)
3. [测试方法](#测试方法)
4. [测试指标](#测试指标)
5. [测试场景](#测试场景)
6. [测试结果分析](#测试结果分析)
7. [常见问题](#常见问题)

---

## 🎯 测试概述

本指南提供了完整的 SDK 性能测试方案，包括：

- **批量发送性能**：测试不同批量大小下的吞吐量和延迟
- **自适应批量大小**：测试网络条件变化时的自适应调整
- **指数退避重试**：测试失败重试机制的有效性
- **离线存储和恢复**：测试离线场景下的数据持久化和恢复
- **数据压缩**：测试压缩算法的效果和性能
- **内存使用**：测试 SDK 的内存占用情况

---

## 🔧 测试环境准备

### 1. 前置条件

- ✅ Node.js 环境（v14+）
- ✅ 后端服务已启动（`http://localhost:3000`）
- ✅ 数据库已配置并运行
- ✅ 测试项目已创建（`perf-test-project`）

### 2. 安装依赖

```bash
# 进入项目目录
cd server

# 安装依赖（如果还没有）
npm install axios
```

### 3. 配置测试参数

编辑 `server/test_sdk_comprehensive.js`，修改以下配置：

```javascript
const API_BASE = 'http://localhost:3000/api';
const PROJECT_ID = 'perf-test-project';  // 修改为您的项目ID
```

### 4. 运行测试

```bash
# 运行完整测试套件
node test_sdk_comprehensive.js

# 或者运行单个测试（需要修改代码）
```

---

## 🧪 测试方法

### 方法1: 使用综合测试脚本（推荐）

**优点**：全面、自动化、包含所有测试场景

```bash
cd server
node test_sdk_comprehensive.js
```

**测试内容**：
1. 批量发送性能（4种批量大小）
2. 自适应批量大小（4种网络条件）
3. 指数退避重试
4. 离线存储和恢复
5. 数据压缩
6. 内存使用情况

**预计耗时**：10-30分钟（取决于数据量和网络条件）

### 方法2: 使用基础性能测试脚本

**优点**：快速、专注批量发送性能

```bash
cd server
node test_sdk_performance.js
```

**测试内容**：
- 批量发送性能（不同批量大小）
- 吞吐量测试
- 延迟测试

**预计耗时**：5-10分钟

### 方法3: 在浏览器中测试（前端SDK）

**优点**：真实环境、可以测试离线存储

1. 启动前端项目
2. 打开浏览器控制台
3. 运行测试代码：

```javascript
// 导入SDK
import AnalyticsSDK from '@/sdk';

// 创建SDK实例
const sdk = AnalyticsSDK.getInstance('test-project', 'http://localhost:3000/api/track', {
  maxBatchSize: 50,
  flushInterval: 2000,
  enableOfflineStorage: true
});

// 测试批量发送
for (let i = 0; i < 1000; i++) {
  sdk.track('test_event', { index: i });
}

// 查看队列状态
console.log(sdk.getQueueStatus());

// 查看网络指标
console.log(await sdk.getNetworkMetrics());

// 查看自适应批量状态
console.log(sdk.getAdaptiveBatchStatus());

// 查看压缩统计
console.log(sdk.getCompressionStats());
```

---

## 📊 测试指标

### 1. 批量发送性能指标

| 指标 | 说明 | 目标值 |
|------|------|--------|
| **吞吐量** | 每秒处理的事件数 | > 1000 事件/秒 |
| **平均延迟** | 批量请求的平均响应时间 | < 500ms |
| **P95延迟** | 95%请求的响应时间 | < 1000ms |
| **P99延迟** | 99%请求的响应时间 | < 2000ms |
| **成功率** | 成功发送的事件占比 | > 99% |

### 2. 自适应批量大小指标

| 网络条件 | 批量大小范围 | 吞吐量目标 |
|----------|--------------|------------|
| **Excellent** | 150-200 | > 2000 事件/秒 |
| **Good** | 80-120 | > 1500 事件/秒 |
| **Fair** | 30-70 | > 800 事件/秒 |
| **Poor** | 10-30 | > 300 事件/秒 |

### 3. 重试机制指标

| 指标 | 说明 | 目标值 |
|------|------|--------|
| **成功率** | 最终成功发送的事件占比 | > 95% |
| **平均重试次数** | 失败事件的平均重试次数 | < 2次 |
| **重试延迟** | 重试之间的延迟时间 | 指数增长（1s, 2s, 4s...） |

### 4. 离线存储指标

| 指标 | 说明 | 目标值 |
|------|------|--------|
| **存储容量** | 可存储的最大事件数 | > 10000 事件 |
| **恢复率** | 离线后恢复的事件占比 | 100% |
| **恢复速度** | 恢复所有事件的时间 | < 60秒 |

### 5. 数据压缩指标

| 指标 | 说明 | 目标值 |
|------|------|--------|
| **压缩比** | 压缩后大小减少的百分比 | > 30% |
| **压缩耗时** | 压缩数据的时间 | < 100ms/批 |
| **解压耗时** | 解压数据的时间 | < 50ms/批 |

### 6. 内存使用指标

| 指标 | 说明 | 目标值 |
|------|------|--------|
| **堆内存增长** | 处理10000个事件后的内存增长 | < 50MB |
| **RSS增长** | 进程总内存增长 | < 100MB |

---

## 🎬 测试场景

### 场景1: 高并发批量发送

**目标**：测试SDK在高并发场景下的性能

**步骤**：
1. 启动100个并发SDK实例
2. 每个实例每秒发送1批（50个事件）
3. 持续10分钟
4. 监控吞吐量、延迟、成功率

**预期结果**：
- 总吞吐量 > 5000 事件/秒
- 平均延迟 < 500ms
- 成功率 > 99%

### 场景2: 弱网环境测试

**目标**：测试SDK在弱网环境下的自适应能力

**步骤**：
1. 使用Chrome DevTools模拟慢速3G网络
2. 发送大量事件
3. 观察批量大小的自动调整
4. 监控发送成功率和延迟

**预期结果**：
- 批量大小自动减小（50 → 20 → 10）
- 成功率 > 95%
- 所有事件最终成功发送

### 场景3: 离线恢复测试

**目标**：测试离线存储和恢复功能

**步骤**：
1. 断开网络连接
2. 发送10000个事件
3. 恢复网络连接
4. 观察自动恢复发送

**预期结果**：
- 所有事件成功存储到localStorage
- 恢复网络后自动发送
- 恢复率 100%

### 场景4: 网络波动测试

**目标**：测试网络条件变化时的自适应调整

**步骤**：
1. 模拟网络条件从Excellent → Poor → Good
2. 持续发送事件
3. 观察批量大小的动态调整

**预期结果**：
- 批量大小随网络条件自动调整
- 发送成功率保持稳定
- 吞吐量适应网络条件

### 场景5: 大数据量压缩测试

**目标**：测试数据压缩的效果

**步骤**：
1. 生成2000个大事件（每个1KB）
2. 启用压缩
3. 测量压缩比和压缩耗时
4. 测试压缩后的发送性能

**预期结果**：
- 压缩比 > 30%
- 压缩耗时 < 100ms
- 发送性能不受影响

---

## 📈 测试结果分析

### 1. 批量发送性能分析

**查看测试结果**：
```bash
node test_sdk_comprehensive.js
```

**分析要点**：
- **最佳批量大小**：吞吐量最高的批量大小
- **延迟分布**：P95和P99延迟是否在可接受范围内
- **成功率**：是否有大量失败，失败原因是什么

**优化建议**：
- 如果延迟过高，减小批量大小
- 如果吞吐量不足，增大批量大小
- 如果成功率低，检查网络和服务器状态

### 2. 自适应批量大小分析

**分析要点**：
- **调整速度**：批量大小是否快速响应网络变化
- **稳定性**：批量大小是否频繁波动
- **效果**：不同网络条件下的吞吐量是否合理

**优化建议**：
- 调整 `adjustmentInterval`（调整间隔）
- 调整 `queueLengthWeight` 和 `networkQualityWeight`（权重）
- 优化网络检测算法

### 3. 重试机制分析

**分析要点**：
- **重试次数**：平均重试次数是否合理
- **重试延迟**：延迟是否按指数增长
- **最终成功率**：重试后是否成功

**优化建议**：
- 调整 `baseDelay` 和 `multiplier`（基础延迟和乘数）
- 调整 `maxDelay`（最大延迟）
- 优化错误类型识别

### 4. 离线存储分析

**分析要点**：
- **存储容量**：是否能存储足够的事件
- **恢复速度**：恢复是否快速
- **数据完整性**：是否有数据丢失

**优化建议**：
- 调整 `maxStorageSize`（最大存储大小）
- 优化压缩算法
- 实现数据分片存储

### 5. 数据压缩分析

**分析要点**：
- **压缩比**：压缩效果是否明显
- **压缩耗时**：压缩是否影响性能
- **解压正确性**：解压后数据是否完整

**优化建议**：
- 选择更合适的压缩算法
- 调整压缩级别
- 优化压缩时机（批量压缩 vs 实时压缩）

---

## ❓ 常见问题

### Q1: 测试脚本运行失败，提示连接错误

**原因**：后端服务未启动或API地址不正确

**解决方法**：
1. 确认后端服务已启动：`cd server && npm start`
2. 检查API地址：`http://localhost:3000/api`
3. 检查项目ID是否存在

### Q2: 测试结果中成功率很低

**原因**：可能是网络问题、服务器负载过高或数据库连接问题

**解决方法**：
1. 检查网络连接
2. 检查服务器日志
3. 检查数据库连接和性能
4. 减小测试数据量

### Q3: 内存使用过高

**原因**：可能是事件队列过大或内存泄漏

**解决方法**：
1. 减小 `maxBatchSize`
2. 减小 `maxStorageSize`
3. 启用数据压缩
4. 检查是否有内存泄漏

### Q4: 压缩效果不明显

**原因**：事件数据本身较小或压缩算法不合适

**解决方法**：
1. 测试更大的事件数据
2. 尝试不同的压缩算法
3. 调整压缩级别
4. 检查是否启用了去重和JSON优化

### Q5: 自适应批量大小不工作

**原因**：网络检测未启用或配置不正确

**解决方法**：
1. 确认 `adaptiveBatch.enabled = true`
2. 检查 `networkCheckInterval` 设置
3. 手动调用 `checkNetworkManually()` 测试
4. 查看 `getNetworkMetrics()` 返回的数据

---

## 📝 测试报告模板

### 测试环境
- **测试时间**：2024-XX-XX
- **测试人员**：XXX
- **测试环境**：Windows 10 / Node.js v18
- **后端版本**：v1.0.0
- **SDK版本**：v1.0.0

### 测试结果

#### 1. 批量发送性能
| 批量大小 | 吞吐量 | 平均延迟 | P95延迟 | 成功率 |
|----------|--------|----------|---------|--------|
| 10 | XXX | XXX | XXX | XXX% |
| 50 | XXX | XXX | XXX | XXX% |
| 100 | XXX | XXX | XXX | XXX% |
| 200 | XXX | XXX | XXX | XXX% |

**最佳批量大小**：XXX

#### 2. 自适应批量大小
| 网络条件 | 批量大小 | 吞吐量 |
|----------|----------|--------|
| Excellent | XXX | XXX |
| Good | XXX | XXX |
| Fair | XXX | XXX |
| Poor | XXX | XXX |

#### 3. 重试机制
- **成功率**：XXX%
- **平均重试次数**：XXX
- **重试延迟**：符合指数增长

#### 4. 离线存储
- **存储容量**：XXX 事件
- **恢复率**：XXX%
- **恢复耗时**：XXX秒

#### 5. 数据压缩
- **压缩比**：XXX%
- **压缩耗时**：XXX ms
- **解压耗时**：XXX ms

### 结论
- ✅ 所有核心功能正常
- ✅ 性能指标达到预期
- ⚠️ 需要优化的点：XXX
- ❌ 存在的问题：XXX

---

## 🔗 相关文档

- [SDK使用文档](../src/sdk/README.md)
- [性能测试方案](./百万级数据性能测试方案.md)
- [项目详细介绍](./项目详细介绍-面试版.md)

---

**最后更新**：2024-XX-XX

