# 预测记录保存与历史查看功能

## 功能概述

已实现预测记录的自动保存和历史查看功能，用户可以：
- 自动保存每次预测的结果
- 查看历史预测记录
- 按条件筛选历史记录
- 查看历史记录的详细信息和图表
- 删除不需要的历史记录

## 实现内容

### 1. 数据库表结构

**文件**: `server/add_prediction_records_table.sql`

创建了 `prediction_records` 表，包含以下字段：
- `id`: 记录ID（UUID）
- `project_id`: 项目ID
- `user_id`: 用户ID（可选）
- `metric_type`: 预测指标类型（pv/uv/conversion_rate）
- `model_type`: 预测模型（lstm/gru）
- `prediction_days`: 预测天数
- `predictions`: 预测结果（JSON）
- `historical_data`: 历史数据快照（JSON，可选）
- `model_info`: 模型信息（JSON，可选）
- `created_at`: 创建时间
- `updated_at`: 更新时间

### 2. 后端服务

**文件**: `server/src/services/predictionRecordService.ts`

实现了预测记录服务，包含：
- `createRecord()`: 创建预测记录
- `getRecordById()`: 根据ID获取记录
- `getRecords()`: 查询记录列表（支持分页和筛选）
- `deleteRecord()`: 删除记录
- `cleanExpiredRecords()`: 清理过期记录（可选）

### 3. API接口

**文件**: `server/src/routes/api.ts`

新增API接口：
- `POST /api/prediction/predict` - 自动保存预测结果
- `POST /api/prediction/predict-batch` - 自动保存批量预测结果
- `GET /api/prediction/records` - 查询历史记录列表
- `GET /api/prediction/records/:id` - 获取记录详情
- `DELETE /api/prediction/records/:id` - 删除记录

### 4. 前端页面

**文件**: `src/pages/PredictionHistory/index.tsx`

创建了历史记录查看页面，功能包括：
- 记录列表展示（表格）
- 筛选功能（指标类型、模型类型、时间范围）
- 分页功能
- 查看详情（图表和表格）
- 删除记录

### 5. 前端API集成

**文件**: `src/services/api.ts`

添加了预测记录相关的API方法：
- `getPredictionRecords()`: 查询历史记录
- `getPredictionRecord()`: 获取记录详情
- `deletePredictionRecord()`: 删除记录

## 使用步骤

### 1. 创建数据库表

执行SQL脚本创建预测记录表：

```bash
# 使用MySQL客户端执行
mysql -u username -p database_name < server/add_prediction_records_table.sql

# 或直接在MySQL客户端中执行SQL文件内容
```

### 2. 重启后端服务

```bash
cd server
npm run dev
```

### 3. 使用功能

1. **自动保存**：
   - 在"时序预测"页面进行预测
   - 预测成功后会自动保存到数据库

2. **查看历史记录**：
   - 点击"时序预测"页面右上角的"查看历史记录"按钮
   - 或在侧边栏"预测"组中点击"预测历史"

3. **筛选和查询**：
   - 按指标类型筛选（PV/UV/转化率）
   - 按模型类型筛选（LSTM/GRU）
   - 按时间范围筛选

4. **查看详情**：
   - 点击记录行的"查看"按钮
   - 查看预测图表和详细数据

5. **删除记录**：
   - 点击记录行的"删除"按钮
   - 确认后删除

## 数据保留策略

- 默认保留所有预测记录
- 可以通过 `cleanExpiredRecords()` 方法清理过期记录（如90天前的记录）
- 建议定期清理，避免数据库过大

## 权限控制

- 用户只能查看和删除自己的预测记录
- 管理员可以查看所有记录（可根据需要扩展）

## 注意事项

1. **数据量**：预测记录会占用数据库空间，建议定期清理旧记录
2. **性能**：大量记录时建议使用分页查询
3. **备份**：重要预测记录建议定期备份

## 后续优化建议

1. **导出功能**：支持导出预测记录为Excel/CSV
2. **对比功能**：对比不同时间的预测结果
3. **预测准确性评估**：与实际数据对比，评估预测准确性
4. **自动清理**：设置自动清理策略，定期删除过期记录
5. **收藏功能**：标记重要的预测记录


