# ç®—æ³•é›†æˆä½¿ç”¨ç¤ºä¾‹

## ğŸ“š ä¸€ã€æ™ºèƒ½æ•°æ®é‡‡æ ·ç®—æ³•ä½¿ç”¨

### 1.1 åœ¨å›¾è¡¨ç»„ä»¶ä¸­ä½¿ç”¨

```typescript
// src/pages/Dashboard/index.tsx
import { adaptiveSampling } from '@/utils/dataSampling';

// åœ¨æ¸²æŸ“å›¾è¡¨å‰è¿›è¡Œé‡‡æ ·
const lineConfig = {
  data: adaptiveSampling(
    statsData.map(item => [
      { date: item.date, value: item.pv, type: 'PV' },
      { date: item.date, value: item.uv, type: 'UV' }
    ]).flat(),
    1000, // æœ€å¤§1000ä¸ªæ•°æ®ç‚¹
    true, // ä½¿ç”¨LTTBç®—æ³•
    'date',
    'value'
  ),
  xField: 'date',
  yField: 'value',
  seriesField: 'type',
  smooth: true,
};
```

### 1.2 åœ¨äº‹ä»¶åˆ†æé¡µé¢ä¸­ä½¿ç”¨

```typescript
// src/pages/EventAnalysis/index.tsx
import { lttbSampling } from '@/utils/dataSampling';

const lineConfig = {
  data: lttbSampling(
    analysisData.map(item => ({
      date: item.date,
      value: item.count,
      type: item.eventName
    })),
    1000,
    'date',
    'value'
  ),
  xField: 'date',
  yField: 'value',
  seriesField: 'type',
};
```

---

## ğŸ“š äºŒã€LRUç¼“å­˜ç®—æ³•ä½¿ç”¨

### 2.1 åœ¨ç»Ÿè®¡æœåŠ¡ä¸­é›†æˆç¼“å­˜

```typescript
// server/src/services/statsService.ts
import { cacheManager } from '../utils/cache';

export class StatsService {
  private cache = cacheManager.getCache<string, any>('stats', 1000, 5 * 60 * 1000); // 5åˆ†é’Ÿè¿‡æœŸ

  async getStats(query: StatsQuery) {
    // ç”Ÿæˆç¼“å­˜é”®
    const cacheKey = `stats:${query.projectId}:${query.startDate}:${query.endDate}:${query.eventName || 'all'}`;
    
    // å°è¯•ä»ç¼“å­˜è·å–
    const cached = this.cache.get(cacheKey);
    if (cached) {
      console.log('ä»ç¼“å­˜è·å–ç»Ÿè®¡æ•°æ®');
      return cached;
    }

    // ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“
    const result = await this.queryFromDatabase(query);
    
    // å­˜å…¥ç¼“å­˜
    this.cache.set(cacheKey, result);
    
    return result;
  }

  private async queryFromDatabase(query: StatsQuery) {
    // åŸæœ‰çš„æ•°æ®åº“æŸ¥è¯¢é€»è¾‘
    // ...
  }
}
```

### 2.2 åœ¨Dashboardæ¦‚è§ˆä¸­ä½¿ç”¨ç¼“å­˜

```typescript
// server/src/services/statsService.ts
async getDashboardOverview(projectId: string) {
  const cacheKey = `overview:${projectId}:${new Date().toISOString().split('T')[0]}`;
  
  const cached = this.cache.get(cacheKey);
  if (cached) {
    return cached;
  }

  // æŸ¥è¯¢æ•°æ®åº“...
  const result = { /* ... */ };
  
  this.cache.set(cacheKey, result);
  return result;
}
```

### 2.3 æ·»åŠ ç¼“å­˜æ¸…ç†æ¥å£ï¼ˆå¯é€‰ï¼‰

```typescript
// server/src/routes/api.ts
import { cacheManager } from '../utils/cache';

// æ·»åŠ ç¼“å­˜ç®¡ç†æ¥å£
router.get('/cache/stats', (req, res) => {
  const stats = cacheManager.getAllStats();
  res.json(stats);
});

router.delete('/cache/clear', (req, res) => {
  cacheManager.clearAll();
  res.json({ success: true, message: 'ç¼“å­˜å·²æ¸…ç©º' });
});
```

---

## ğŸ“š ä¸‰ã€å¼‚å¸¸æ£€æµ‹ç®—æ³•ä½¿ç”¨

### 3.1 åœ¨è·¯ç”±ä¸­æ·»åŠ å¼‚å¸¸æ£€æµ‹æ¥å£

```typescript
// server/src/routes/api.ts
import { AnomalyDetectionService } from '../services/anomalyDetectionService';

const anomalyService = new AnomalyDetectionService(db);

// è·å–ä»Šæ—¥å¼‚å¸¸
router.get('/anomalies/:projectId', async (req, res) => {
  try {
    const { projectId } = req.params;
    const today = new Date().toISOString().split('T')[0];
    
    const anomalies = await anomalyService.detectAnomalies(projectId, today);
    
    res.json({
      success: true,
      data: anomalies,
      count: anomalies.length
    });
  } catch (error: any) {
    res.status(500).json({ success: false, error: error.message });
  }
});
```

### 3.2 åœ¨å®šæ—¶ä»»åŠ¡ä¸­è‡ªåŠ¨æ£€æµ‹å¼‚å¸¸

```typescript
// server/src/services/schedulerService.ts
import { AnomalyDetectionService } from './anomalyDetectionService';

// æ¯å°æ—¶æ£€æµ‹ä¸€æ¬¡å¼‚å¸¸
cron.schedule('0 * * * *', async () => {
  console.log('å¼€å§‹å¼‚å¸¸æ£€æµ‹...');
  
  const anomalyService = new AnomalyDetectionService(db);
  const today = new Date().toISOString().split('T')[0];
  
  // è·å–æ‰€æœ‰é¡¹ç›®
  const [projects] = await db.execute('SELECT id FROM projects');
  
  for (const project of projects as any[]) {
    try {
      const anomalies = await anomalyService.detectAnomalies(project.id, today);
      
      if (anomalies.length > 0) {
        console.log(`é¡¹ç›® ${project.id} æ£€æµ‹åˆ° ${anomalies.length} ä¸ªå¼‚å¸¸`);
        
        // å¯ä»¥å‘é€é€šçŸ¥ï¼ˆé‚®ä»¶ã€çŸ­ä¿¡ç­‰ï¼‰
        // await emailService.sendAnomalyAlert(project.id, anomalies);
      }
    } catch (error) {
      console.error(`é¡¹ç›® ${project.id} å¼‚å¸¸æ£€æµ‹å¤±è´¥:`, error);
    }
  }
});
```

### 3.3 åœ¨å‰ç«¯å±•ç¤ºå¼‚å¸¸ä¿¡æ¯

```typescript
// src/pages/Dashboard/index.tsx
import { useState, useEffect } from 'react';
import { Alert, Badge } from 'antd';
import { apiService } from '@/services/api';

const Dashboard: React.FC = () => {
  const [anomalies, setAnomalies] = useState([]);

  useEffect(() => {
    // è·å–å¼‚å¸¸ä¿¡æ¯
    const fetchAnomalies = async () => {
      try {
        const data = await apiService.getAnomalies(selectedProjectId);
        setAnomalies(data);
      } catch (error) {
        console.error('è·å–å¼‚å¸¸ä¿¡æ¯å¤±è´¥:', error);
      }
    };

    fetchAnomalies();
  }, [selectedProjectId]);

  return (
    <div>
      {/* å¼‚å¸¸å‘Šè­¦ */}
      {anomalies.length > 0 && (
        <Alert
          message={
            <span>
              æ£€æµ‹åˆ° <Badge count={anomalies.length} /> ä¸ªå¼‚å¸¸
            </span>
          }
          description={anomalies.map(a => a.description).join('; ')}
          type="warning"
          showIcon
          style={{ marginBottom: 16 }}
        />
      )}
      
      {/* å…¶ä»–å†…å®¹... */}
    </div>
  );
};
```

### 3.4 åœ¨APIæœåŠ¡ä¸­æ·»åŠ æ–¹æ³•

```typescript
// src/services/api.ts
export const apiService = {
  // ... å…¶ä»–æ–¹æ³•

  async getAnomalies(projectId: string) {
    const response = await http.get(`/api/anomalies/${projectId}`);
    return response.data;
  },
};
```

---

## ğŸ“š å››ã€ä¼˜åŒ–SDKä¸­çš„æŒ‡æ•°é€€é¿ç®—æ³•

### 4.1 ä¼˜åŒ–é‡è¯•é€»è¾‘

```typescript
// src/sdk/index.ts
private handleFailedEvents(failedEvents: QueuedEvent[]): void {
  failedEvents.forEach(event => {
    event.retryCount++;
    
    if (event.retryCount < this.batchConfig.maxRetries) {
      // ä¼˜åŒ–åçš„æŒ‡æ•°é€€é¿ç®—æ³•ï¼ˆå¸¦æŠ–åŠ¨ï¼‰
      const baseDelay = this.batchConfig.retryDelay;
      const exponentialDelay = baseDelay * Math.pow(2, event.retryCount);
      
      // æ·»åŠ æŠ–åŠ¨ï¼ˆJitterï¼‰ï¼Œé¿å…"é›·ç¾¤æ•ˆåº”"
      const jitter = Math.random() * 0.3 * exponentialDelay; // 30%æŠ–åŠ¨
      
      // è®¾ç½®æœ€å¤§å»¶è¿Ÿï¼ˆ30ç§’ï¼‰
      const finalDelay = Math.min(exponentialDelay + jitter, 30000);
      
      setTimeout(() => {
        this.eventQueue.push(event);
      }, finalDelay);
    } else {
      // è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œä¿å­˜åˆ°ç¦»çº¿å­˜å‚¨
      console.warn(`äº‹ä»¶ ${event.id} é‡è¯•æ¬¡æ•°è¶…é™ï¼Œä¿å­˜åˆ°ç¦»çº¿å­˜å‚¨`);
      if (this.batchConfig.enableOfflineStorage) {
        this.saveEventToOfflineStorage(event);
      }
    }
  });
}
```

---

## ğŸ“š äº”ã€å®Œæ•´é›†æˆæ­¥éª¤

### æ­¥éª¤1ï¼šå®‰è£…ä¾èµ–ï¼ˆå¦‚æœéœ€è¦ï¼‰

```bash
# å¦‚æœä½¿ç”¨Pythonåšæ—¶åºé¢„æµ‹ï¼Œéœ€è¦å®‰è£…
pip install tensorflow numpy pandas

# Node.jsç‰ˆæœ¬ï¼ˆå¯é€‰ï¼‰
npm install @tensorflow/tfjs-node
```

### æ­¥éª¤2ï¼šæ›´æ–°ç±»å‹å®šä¹‰

```typescript
// src/types/index.ts
export interface Anomaly {
  type: 'pv' | 'uv' | 'event' | 'conversion';
  metric: string;
  value: number;
  expectedValue: number;
  deviation: number;
  severity: 'low' | 'medium' | 'high';
  timestamp: string;
  description: string;
}
```

### æ­¥éª¤3ï¼šæµ‹è¯•ç®—æ³•æ•ˆæœ

```typescript
// æµ‹è¯•æ•°æ®é‡‡æ ·
import { lttbSampling } from '@/utils/dataSampling';

const testData = Array.from({ length: 10000 }, (_, i) => ({
  date: new Date(2024, 0, i).toISOString(),
  value: Math.random() * 100
}));

const sampled = lttbSampling(testData, 1000);
console.log(`åŸå§‹æ•°æ®: ${testData.length} æ¡ï¼Œé‡‡æ ·å: ${sampled.length} æ¡`);
```

---

## ğŸ“š å…­ã€æ€§èƒ½ç›‘æ§

### 6.1 ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡

```typescript
// server/src/routes/api.ts
router.get('/cache/stats', (req, res) => {
  const stats = cacheManager.getAllStats();
  res.json({
    success: true,
    data: stats
  });
});
```

### 6.2 ç›‘æ§å¼‚å¸¸æ£€æµ‹æ€§èƒ½

```typescript
// åœ¨å¼‚å¸¸æ£€æµ‹æœåŠ¡ä¸­æ·»åŠ æ€§èƒ½ç›‘æ§
async detectAnomalies(projectId: string, date: string): Promise<Anomaly[]> {
  const startTime = Date.now();
  
  const anomalies = await this.performDetection(projectId, date);
  
  const duration = Date.now() - startTime;
  console.log(`å¼‚å¸¸æ£€æµ‹è€—æ—¶: ${duration}msï¼Œæ£€æµ‹åˆ° ${anomalies.length} ä¸ªå¼‚å¸¸`);
  
  return anomalies;
}
```

---

## ğŸ¯ ä¸ƒã€ä¸‹ä¸€æ­¥å»ºè®®

1. **ä¼˜å…ˆé›†æˆæ•°æ®é‡‡æ ·ç®—æ³•**ï¼šæ•ˆæœæ˜æ˜¾ï¼Œå®ç°ç®€å•
2. **é›†æˆLRUç¼“å­˜**ï¼šæå‡æŸ¥è¯¢æ€§èƒ½
3. **é›†æˆå¼‚å¸¸æ£€æµ‹**ï¼šå¢åŠ ç³»ç»Ÿäº®ç‚¹
4. **å®ç°æ—¶åºé¢„æµ‹**ï¼šå¦‚æœå­¦æ ¡è¦æ±‚æ·±åº¦å­¦ä¹ ï¼Œè¿™æ˜¯å¿…é€‰é¡¹

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ç¼“å­˜ä¸€è‡´æ€§**ï¼šæ•°æ®æ›´æ–°æ—¶éœ€è¦æ¸…ç†ç›¸å…³ç¼“å­˜
2. **å¼‚å¸¸æ£€æµ‹é¢‘ç‡**ï¼šä¸è¦è¿‡äºé¢‘ç¹ï¼Œé¿å…æ€§èƒ½é—®é¢˜
3. **é‡‡æ ·ç²¾åº¦**ï¼šæ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´é‡‡æ ·ç‚¹æ•°
4. **é”™è¯¯å¤„ç†**ï¼šæ‰€æœ‰ç®—æ³•éƒ½è¦æœ‰é™çº§æ–¹æ¡ˆ




