# åŸ‹ç‚¹æ•°æ®å¯è§†åŒ–å¹³å° - æ•°æ®é€šä¿¡å®ç°è¯¦è§£

## ğŸ“‹ ä¸€ã€æ•°æ®é€šä¿¡æ¶æ„æ¦‚è§ˆ

é¡¹ç›®é‡‡ç”¨**åˆ†å±‚é€šä¿¡æ¶æ„**ï¼ŒåŒ…å«ä¸‰ä¸ªä¸»è¦é€šä¿¡å±‚ï¼š
1. **å‰ç«¯ â†” åç«¯**ï¼šåŸºäºAxiosçš„HTTPé€šä¿¡ï¼ˆRESTful APIï¼‰
2. **SDK â†” åç«¯**ï¼šåŸºäºFetchçš„æ‰¹é‡HTTPé€šä¿¡ï¼ˆä¼˜åŒ–æ€§èƒ½ï¼‰
3. **åç«¯ â†” MLæœåŠ¡**ï¼šåŸºäºAxiosçš„HTTPé€šä¿¡ï¼ˆæ·±åº¦å­¦ä¹ é¢„æµ‹ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯åº”ç”¨   â”‚ â”€â”€â”€â”€â”€â”€â–º â”‚  Node.js    â”‚ â”€â”€â”€â”€â”€â”€â–º â”‚  Python ML  â”‚
â”‚  (React)    â”‚  HTTP   â”‚   åç«¯      â”‚  HTTP   â”‚   æœåŠ¡      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                        â”‚
      â”‚                        â”‚
      â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   SDK       â”‚ â”€â”€â”€â”€â”€â”€â–º â”‚  Node.js    â”‚
â”‚  (æ‰¹é‡)     â”‚  HTTP   â”‚   åç«¯      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ äºŒã€å‰ç«¯ä¸åç«¯é€šä¿¡ï¼ˆHTTP RESTful APIï¼‰

### 2.1 HTTPè¯·æ±‚å°è£…ï¼ˆAxiosï¼‰

**å®ç°ä½ç½®**ï¼š`src/utils/http.ts`

**æ ¸å¿ƒå®ç°**ï¼š
```typescript
import axios from 'axios'

const instance = axios.create({
  baseURL: import.meta.env.VITE_API_BASE_URL || 'http://localhost:3000/api',
  timeout: 10000  // é»˜è®¤10ç§’è¶…æ—¶
})

// è¯·æ±‚æ‹¦æˆªå™¨ï¼šè‡ªåŠ¨æ·»åŠ JWT Token
instance.interceptors.request.use(config => {
  const token = localStorage.getItem('token')
  if (token) {
    config.headers.Authorization = `Bearer ${token}`
  }
  return config
})

// å“åº”æ‹¦æˆªå™¨ï¼šç»Ÿä¸€é”™è¯¯å¤„ç†
instance.interceptors.response.use(
  response => response.data,  // ç›´æ¥è¿”å›dataï¼Œç®€åŒ–ä½¿ç”¨
  error => {
    const status = error?.response?.status
    if (status === 401) {
      // 401æœªæˆæƒï¼šæ¸…é™¤æœ¬åœ°ä¼šè¯å¹¶è·³è½¬ç™»å½•
      localStorage.removeItem('token')
      localStorage.removeItem('userInfo')
      if (window.location.pathname !== '/login') {
        window.location.href = '/login'
      }
    }
    console.error('API Error:', error)
    return Promise.reject(error)
  }
)
```

**æŠ€æœ¯äº®ç‚¹**ï¼š
- **ç»Ÿä¸€é…ç½®**ï¼šbaseURLã€timeoutç»Ÿä¸€ç®¡ç†
- **è‡ªåŠ¨è®¤è¯**ï¼šè¯·æ±‚æ‹¦æˆªå™¨è‡ªåŠ¨æ·»åŠ JWT Token
- **ç»Ÿä¸€é”™è¯¯å¤„ç†**ï¼š401è‡ªåŠ¨è·³è½¬ç™»å½•ï¼Œå…¶ä»–é”™è¯¯ç»Ÿä¸€å¤„ç†
- **ç®€åŒ–ä½¿ç”¨**ï¼šå“åº”æ‹¦æˆªå™¨ç›´æ¥è¿”å›dataï¼Œæ— éœ€`.data.data`

### 2.2 APIæœåŠ¡å°è£…

**å®ç°ä½ç½®**ï¼š`src/services/api.ts`

**è®¾è®¡æ¨¡å¼**ï¼šç»Ÿä¸€APIæœåŠ¡å¯¹è±¡ï¼Œæ‰€æœ‰APIæ–¹æ³•é›†ä¸­ç®¡ç†

**æ ¸å¿ƒå®ç°**ï¼š
```typescript
export const apiService = {
  // GETè¯·æ±‚ç¤ºä¾‹
  async getStats(params: StatsQuery): Promise<StatsData[]> {
    const data = await api.get('/stats', { params });
    return data.data;
  },

  // POSTè¯·æ±‚ç¤ºä¾‹
  async createEventDefinition(eventDef: Omit<EventDefinition, 'id'>): Promise<EventDefinition> {
    const data = await api.post('/event-definitions', eventDef);
    return data.data;
  },

  // å¸¦è¶…æ—¶é…ç½®çš„è¯·æ±‚ï¼ˆAIæ€»ç»“ã€é¢„æµ‹ç­‰é•¿æ—¶é—´æ“ä½œï¼‰
  async sendAISummaryNow() {
    const data = await api.post('/ai-summary/send-now', {}, {
      timeout: 120000  // 120ç§’è¶…æ—¶
    });
    return data;
  },

  async predict(params: PredictionParams) {
    const data = await api.post('/prediction/predict', params, {
      timeout: 60000  // 60ç§’è¶…æ—¶ï¼ˆé¦–æ¬¡é¢„æµ‹éœ€è¦è®­ç»ƒæ¨¡å‹ï¼‰
    });
    return data;
  }
}
```

**æŠ€æœ¯äº®ç‚¹**ï¼š
- **ç±»å‹å®‰å…¨**ï¼šæ‰€æœ‰APIæ–¹æ³•éƒ½æœ‰TypeScriptç±»å‹å®šä¹‰
- **ç»Ÿä¸€æ¥å£**ï¼šæ‰€æœ‰APIè°ƒç”¨éƒ½é€šè¿‡apiServiceï¼Œä¾¿äºç»´æŠ¤
- **çµæ´»è¶…æ—¶**ï¼šä¸åŒæ“ä½œå¯ä»¥è®¾ç½®ä¸åŒçš„è¶…æ—¶æ—¶é—´
- **é”™è¯¯å¤„ç†**ï¼šç»Ÿä¸€çš„try-catchå’Œé”™è¯¯æç¤º

### 2.3 å¼€å‘ç¯å¢ƒä»£ç†é…ç½®

**å®ç°ä½ç½®**ï¼š`vite.config.ts`

**æ ¸å¿ƒå®ç°**ï¼š
```typescript
export default defineConfig({
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:3000',
        changeOrigin: true
      }
    }
  }
})
```

**ä½œç”¨**ï¼š
- å¼€å‘ç¯å¢ƒè§£å†³CORSé—®é¢˜
- ç»Ÿä¸€APIè·¯å¾„ï¼ˆå‰ç«¯ä½¿ç”¨`/api/xxx`ï¼Œè‡ªåŠ¨ä»£ç†åˆ°`http://localhost:3000/api/xxx`ï¼‰
- ç”Ÿäº§ç¯å¢ƒé€šè¿‡nginxæˆ–ç±»ä¼¼å·¥å…·é…ç½®åå‘ä»£ç†

---

## ğŸ“¦ ä¸‰ã€SDKä¸åç«¯é€šä¿¡ï¼ˆæ‰¹é‡HTTPé€šä¿¡ï¼‰

### 3.1 æ‰¹é‡å‘é€æœºåˆ¶

**å®ç°ä½ç½®**ï¼š`src/sdk/index.ts`

**æ ¸å¿ƒå®ç°**ï¼š
```typescript
// æ‰¹é‡å‘é€æ•°æ®æ ¼å¼
const batchData = {
  projectId: this.projectId,
  events: events.map(event => event.data),  // æå–äº‹ä»¶æ•°æ®
  batchSize: events.length,
  timestamp: Date.now(),
  ...this.commonParams  // å…¬å…±å‚æ•°ï¼ˆdeviceInfoã€sdkVersionç­‰ï¼‰
}

// ä½¿ç”¨Fetch APIå‘é€ï¼ˆåŸç”ŸAPIï¼Œæ— ä¾èµ–ï¼‰
const response = await fetch(this.endpoint, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify(batchData),
  signal: controller.signal  // AbortControlleræ”¯æŒè¶…æ—¶å–æ¶ˆ
})
```

**æŠ€æœ¯äº®ç‚¹**ï¼š
- **ä½¿ç”¨åŸç”ŸFetch**ï¼šSDKä½“ç§¯å°ï¼Œæ— é¢å¤–ä¾èµ–
- **æ‰¹é‡æ‰“åŒ…**ï¼š50ä¸ªäº‹ä»¶æ‰“åŒ…æˆ1ä¸ªè¯·æ±‚ï¼Œå‡å°‘98%çš„HTTPè¯·æ±‚
- **è¶…æ—¶æ§åˆ¶**ï¼šä½¿ç”¨AbortControllerå®ç°10ç§’è¶…æ—¶
- **å…¬å…±å‚æ•°æå–**ï¼šprojectIdã€deviceInfoç­‰å…¬å…±å‚æ•°åªä¼ ä¸€æ¬¡

### 3.2 è‡ªé€‚åº”æ‰¹é‡å¤§å°

**å®ç°æœºåˆ¶**ï¼š
- æ ¹æ®ç½‘ç»œçŠ¶å†µï¼ˆRTTã€å¸¦å®½ã€è¿æ¥è´¨é‡ï¼‰åŠ¨æ€è°ƒæ•´æ‰¹é‡å¤§å°
- æ ¹æ®é˜Ÿåˆ—é•¿åº¦åŠ¨æ€è°ƒæ•´æ‰¹é‡å¤§å°
- åŠ æƒåˆå¹¶ï¼šç½‘ç»œè´¨é‡70% + é˜Ÿåˆ—é•¿åº¦30%

**æ‰¹é‡å¤§å°èŒƒå›´**ï¼š10-100ä¸ªäº‹ä»¶ï¼ˆæ ¹æ®ç½‘ç»œçŠ¶å†µè‡ªåŠ¨è°ƒæ•´ï¼‰

**æ€§èƒ½ä¼˜åŒ–**ï¼š
- å¼±ç½‘ç¯å¢ƒï¼šå‡å°æ‰¹é‡å¤§å°ï¼ˆ10-30ä¸ªï¼‰ï¼Œæé«˜æˆåŠŸç‡
- å¼ºç½‘ç¯å¢ƒï¼šå¢å¤§æ‰¹é‡å¤§å°ï¼ˆ50-100ä¸ªï¼‰ï¼Œæé«˜æ•ˆç‡
- é˜Ÿåˆ—ç§¯å‹ï¼šå¢å¤§æ‰¹é‡å¤§å°ï¼Œå¿«é€Ÿæ¸…ç©ºé˜Ÿåˆ—

### 3.3 é”™è¯¯å¤„ç†ä¸é‡è¯•

**é”™è¯¯åˆ†ç±»**ï¼š
```typescript
// æ ¹æ®é”™è¯¯ç±»å‹é€‰æ‹©ä¸åŒçš„é‡è¯•ç­–ç•¥
type ErrorType = 'network' | 'timeout' | 'server' | 'client' | 'unknown';

// é”™è¯¯åˆ†ç±»é€»è¾‘
if (errorMessage.includes('timeout') || errorName === 'AbortError') {
  return 'timeout';
} else if (errorMessage.includes('network') || errorMessage.includes('fetch')) {
  return 'network';
} else if (statusCode >= 500) {
  return 'server';
} else if (statusCode >= 400) {
  return 'client';
}
```

**é‡è¯•ç­–ç•¥**ï¼š
- **æŒ‡æ•°é€€é¿**ï¼š`baseDelay * 2^(retryCount-1)`
- **æŠ–åŠ¨æœºåˆ¶**ï¼šæ·»åŠ Â±10%éšæœºæŠ–åŠ¨ï¼Œé¿å…é›·ç¾¤æ•ˆåº”
- **é”™è¯¯ç±»å‹æ„ŸçŸ¥**ï¼šç½‘ç»œé”™è¯¯å»¶è¿ŸÃ—1.2ï¼Œè¶…æ—¶é”™è¯¯å»¶è¿ŸÃ—1.5
- **ç½‘ç»œçŠ¶å†µæ„ŸçŸ¥**ï¼šç½‘ç»œå¥½æ—¶å‡å°‘å»¶è¿Ÿï¼Œç½‘ç»œå·®æ—¶å¢åŠ å»¶è¿Ÿ

### 3.4 ç¦»çº¿å­˜å‚¨ä¸æ¢å¤

**å®ç°æœºåˆ¶**ï¼š
```typescript
// ç½‘ç»œæ–­å¼€æ—¶è‡ªåŠ¨ä¿å­˜
window.addEventListener('offline', () => {
  this.isOnline = false;
  this.saveToOfflineStorage();  // ä¿å­˜åˆ°localStorageï¼ˆå‹ç¼©ï¼‰
});

// ç½‘ç»œæ¢å¤æ—¶è‡ªåŠ¨å‘é€
window.addEventListener('online', () => {
  this.isOnline = true;
  this.loadOfflineEvents();  // åŠ è½½ç¦»çº¿äº‹ä»¶
  this.flushQueue();         // ç«‹å³å‘é€
});
```

**å­˜å‚¨ä¼˜åŒ–**ï¼š
- æ•°æ®å‹ç¼©ï¼šå‹ç¼©æ¯”50-80%
- å­˜å‚¨é™åˆ¶ï¼šé»˜è®¤1MBï¼Œè¶…å‡ºæ—¶åˆ é™¤æœ€æ—§çš„äº‹ä»¶
- è‡ªåŠ¨æ¢å¤ï¼šç½‘ç»œæ¢å¤åè‡ªåŠ¨åŠ è½½å¹¶å‘é€

---

## ğŸ¤– å››ã€åç«¯ä¸MLæœåŠ¡é€šä¿¡ï¼ˆHTTPï¼‰

### 4.1 MLæœåŠ¡è°ƒç”¨

**å®ç°ä½ç½®**ï¼š`server/src/services/predictionService.ts`

**æ ¸å¿ƒå®ç°**ï¼š
```typescript
export class PredictionService {
  private mlServiceUrl: string;

  constructor(private db: Connection) {
    // ä»ç¯å¢ƒå˜é‡è·å–MLæœåŠ¡åœ°å€
    this.mlServiceUrl = process.env.ML_SERVICE_URL || 'http://127.0.0.1:5000';
  }

  // å¥åº·æ£€æŸ¥
  async checkMLServiceHealth(): Promise<boolean> {
    try {
      const response = await axios.get(`${this.mlServiceUrl}/health`, {
        timeout: 5000,
        family: 4,  // å¼ºåˆ¶ä½¿ç”¨IPv4ï¼Œé¿å…IPv6è¿æ¥é—®é¢˜
        maxRedirects: 0
      });
      return response.status === 200;
    } catch (error) {
      return false;
    }
  }

  // é¢„æµ‹è¯·æ±‚
  async predict(request: PredictionRequest): Promise<PredictionResponse> {
    // 1. è·å–å†å²æ•°æ®
    const historicalData = await this.getHistoricalData(request.projectId);
    
    // 2. è°ƒç”¨MLæœåŠ¡
    const response = await axios.post(
      `${this.mlServiceUrl}/predict`,
      {
        projectId: request.projectId,
        metricType: request.metricType,
        modelType: request.modelType,
        days: request.days,
        historicalData: historicalData
      },
      {
        timeout: 90000,  // 90ç§’è¶…æ—¶ï¼ˆé¦–æ¬¡é¢„æµ‹éœ€è¦è®­ç»ƒæ¨¡å‹ï¼‰
        family: 4,       // å¼ºåˆ¶IPv4
        maxRedirects: 0
      }
    );
    
    return response.data;
  }
}
```

**æŠ€æœ¯äº®ç‚¹**ï¼š
- **å¥åº·æ£€æŸ¥**ï¼šå®šæœŸæ£€æŸ¥MLæœåŠ¡çŠ¶æ€
- **è¶…æ—¶æ§åˆ¶**ï¼š90ç§’è¶…æ—¶ï¼ˆé¦–æ¬¡é¢„æµ‹éœ€è¦è®­ç»ƒæ¨¡å‹ï¼‰
- **IPv4å¼ºåˆ¶**ï¼šé¿å…IPv6/IPv4è§£æé—®é¢˜
- **é”™è¯¯å¤„ç†**ï¼šæœåŠ¡ä¸å¯ç”¨æ—¶è¿”å›å‹å¥½é”™è¯¯ä¿¡æ¯

### 4.2 æ‰¹é‡é¢„æµ‹

**å®ç°æœºåˆ¶**ï¼š
```typescript
// æ‰¹é‡é¢„æµ‹å¤šä¸ªæŒ‡æ ‡
async predictBatch(request: {
  projectId: string;
  metrics: Array<'pv' | 'uv' | 'conversion_rate'>;
  modelType: 'lstm' | 'gru';
  days: number;
}): Promise<Record<string, PredictionResponse>> {
  // å¹¶å‘è°ƒç”¨å¤šä¸ªé¢„æµ‹
  const promises = request.metrics.map(metric =>
    this.predict({
      projectId: request.projectId,
      metricType: metric,
      modelType: request.modelType,
      days: request.days
    })
  );
  
  const results = await Promise.all(promises);
  
  // ç»„è£…ç»“æœ
  const batchResults: Record<string, PredictionResponse> = {};
  request.metrics.forEach((metric, index) => {
    batchResults[metric] = results[index];
  });
  
  return batchResults;
}
```

**æŠ€æœ¯äº®ç‚¹**ï¼š
- **å¹¶å‘å¤„ç†**ï¼šä½¿ç”¨Promise.allå¹¶å‘è°ƒç”¨ï¼Œæé«˜æ•ˆç‡
- **ç»“æœç»„è£…**ï¼šç»Ÿä¸€è¿”å›æ ¼å¼ï¼Œä¾¿äºå‰ç«¯å¤„ç†
- **é”™è¯¯éš”ç¦»**ï¼šå•ä¸ªæŒ‡æ ‡å¤±è´¥ä¸å½±å“å…¶ä»–æŒ‡æ ‡

---

## ğŸ” äº”ã€è®¤è¯ä¸æˆæƒæœºåˆ¶

### 5.1 JWT Tokenè®¤è¯

**å‰ç«¯å®ç°**ï¼š
```typescript
// è¯·æ±‚æ‹¦æˆªå™¨è‡ªåŠ¨æ·»åŠ Token
instance.interceptors.request.use(config => {
  const token = localStorage.getItem('token')
  if (token) {
    config.headers.Authorization = `Bearer ${token}`
  }
  return config
})
```

**åç«¯å®ç°**ï¼š
```typescript
// è®¤è¯ä¸­é—´ä»¶
const authMiddleware: express.RequestHandler = (req, res, next) => {
  try {
    const auth = req.headers.authorization || '';
    const token = auth.startsWith('Bearer ') ? auth.slice(7) : '';
    
    if (!token) {
      return res.status(401).json({ success: false, error: 'Unauthorized' });
    }
    
    // éªŒè¯Token
    const payload = jwt.verify(token, JWT_SECRET) as {
      sub: string;      // ç”¨æˆ·ID
      username: string;
      role: string;     // è§’è‰²ï¼šAdmin/User
    };
    
    // å°†ç”¨æˆ·ä¿¡æ¯é™„åŠ åˆ°è¯·æ±‚å¯¹è±¡
    (req as any).user = payload;
    next();
  } catch (e) {
    return res.status(401).json({ success: false, error: 'Unauthorized' });
  }
};

// åº”ç”¨ä¸­é—´ä»¶ï¼ˆéœ€è¦è®¤è¯çš„è·¯ç”±ï¼‰
router.post('/event-definitions', authMiddleware, async (req, res) => {
  // è·¯ç”±å¤„ç†é€»è¾‘
});
```

**æŠ€æœ¯äº®ç‚¹**ï¼š
- **æ— çŠ¶æ€è®¤è¯**ï¼šJWT TokenåŒ…å«ç”¨æˆ·ä¿¡æ¯ï¼Œæ— éœ€æœåŠ¡å™¨å­˜å‚¨ä¼šè¯
- **è‡ªåŠ¨æ³¨å…¥**ï¼šå‰ç«¯è¯·æ±‚æ‹¦æˆªå™¨è‡ªåŠ¨æ·»åŠ Token
- **ç»Ÿä¸€å¤„ç†**ï¼š401é”™è¯¯è‡ªåŠ¨è·³è½¬ç™»å½•
- **è§’è‰²æƒé™**ï¼šTokenåŒ…å«è§’è‰²ä¿¡æ¯ï¼Œæ”¯æŒæƒé™æ§åˆ¶

### 5.2 è·¯ç”±ä¿æŠ¤

**å®ç°ä½ç½®**ï¼š`src/router/index.tsx`

**æ ¸å¿ƒå®ç°**ï¼š
```typescript
// è·¯ç”±å®ˆå«ç»„ä»¶
const Protected: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const token = localStorage.getItem('token');
  
  if (!token) {
    return <Navigate to="/login" replace />;
  }
  
  return <>{children}</>;
};

// å—ä¿æŠ¤çš„è·¯ç”±
{
  path: '/app',
  element: (
    <Protected>
      <App />
    </Protected>
  ),
  children: [
    { path: 'dashboard', element: <Dashboard /> },
    // ...
  ]
}
```

---

## ğŸ“¡ å…­ã€åç«¯APIè·¯ç”±è®¾è®¡

### 6.1 RESTful APIè®¾è®¡

**è·¯ç”±ç»“æ„**ï¼š
```typescript
// ç”¨æˆ·è®¤è¯ï¼ˆå…¬å¼€ï¼‰
POST   /api/login          // ç™»å½•
POST   /api/register       // æ³¨å†Œ

// äº‹ä»¶è¿½è¸ªï¼ˆå…¬å¼€ï¼ŒSDKä½¿ç”¨ï¼‰
POST   /api/track          // å•ä¸ªäº‹ä»¶æˆ–æ‰¹é‡äº‹ä»¶

// ç»Ÿè®¡æ•°æ®ï¼ˆéœ€è¦è®¤è¯ï¼‰
GET    /api/stats          // è·å–ç»Ÿè®¡æ•°æ®
GET    /api/dashboard/overview  // è·å–æ¦‚è§ˆæ•°æ®

// äº‹ä»¶å®šä¹‰ï¼ˆéœ€è¦è®¤è¯ï¼‰
GET    /api/event-definitions    // è·å–äº‹ä»¶å®šä¹‰åˆ—è¡¨
POST   /api/event-definitions    // åˆ›å»ºäº‹ä»¶å®šä¹‰
PUT    /api/event-definitions/:id  // æ›´æ–°äº‹ä»¶å®šä¹‰
DELETE /api/event-definitions/:id  // åˆ é™¤äº‹ä»¶å®šä¹‰

// äº‹ä»¶åˆ†æï¼ˆéœ€è¦è®¤è¯ï¼‰
GET    /api/events/analysis      // äº‹ä»¶åˆ†ææ•°æ®
GET    /api/funnel/analysis      // æ¼æ–—åˆ†ææ•°æ®

// æ—¶åºé¢„æµ‹ï¼ˆéœ€è¦è®¤è¯ï¼‰
GET    /api/prediction/health    // æ£€æŸ¥MLæœåŠ¡çŠ¶æ€
POST   /api/prediction/predict   // å•ä¸ªæŒ‡æ ‡é¢„æµ‹
POST   /api/prediction/predict-batch  // æ‰¹é‡é¢„æµ‹

// AIæ€»ç»“ï¼ˆéœ€è¦è®¤è¯ï¼‰
GET    /api/ai-summary/settings  // è·å–è®¾ç½®
POST   /api/ai-summary/settings  // æ›´æ–°è®¾ç½®
POST   /api/ai-summary/send-now  // ç«‹å³å‘é€æ€»ç»“
```

### 6.2 æ‰¹é‡äº‹ä»¶å¤„ç†

**åç«¯å®ç°**ï¼š`server/src/services/trackingService.ts`

**æ ¸å¿ƒå®ç°**ï¼š
```typescript
async trackBatchEvents(batchData: {
  projectId: string;
  events: EventData[];
  batchSize: number;
  timestamp: number;
  uid?: string;
  deviceInfo: any;
  sdkVersion: string;
}): Promise<{ success: boolean; processedCount: number; failedEvents?: any[] }> {
  // ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡å¤„ç†æ‰¹é‡æ’å…¥
  await this.db.beginTransaction();
  
  try {
    const failedEvents: any[] = [];
    let processedCount = 0;
    
    // éå†æ¯ä¸ªäº‹ä»¶
    for (const eventData of batchData.events) {
      try {
        // æ£€æŸ¥äº‹ä»¶å®šä¹‰æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™è‡ªåŠ¨åˆ›å»º
        const exists = await this.validateEventDefinition(
          batchData.projectId, 
          eventData.eventName
        );
        
        if (!exists) {
          await this.createEventDefinition(batchData.projectId, eventData.eventName);
        }
        
        // æ’å…¥äº‹ä»¶æ•°æ®
        await this.db.execute(
          'INSERT INTO events (project_id, event_name, event_params, user_id, device_info, timestamp) VALUES (?, ?, ?, ?, ?, ?)',
          [
            batchData.projectId,
            eventData.eventName,
            JSON.stringify(eventData.eventParams || {}),
            batchData.uid || null,
            JSON.stringify(batchData.deviceInfo || {}),
            new Date(eventData.timestamp || Date.now()).toISOString()
          ]
        );
        
        processedCount++;
      } catch (error) {
        // å•ä¸ªäº‹ä»¶å¤±è´¥ä¸å½±å“å…¶ä»–äº‹ä»¶
        failedEvents.push(eventData);
      }
    }
    
    // æäº¤äº‹åŠ¡
    await this.db.commit();
    
    return {
      success: true,
      processedCount,
      failedEvents: failedEvents.length > 0 ? failedEvents : undefined
    };
  } catch (error) {
    // å›æ»šäº‹åŠ¡
    await this.db.rollback();
    throw error;
  }
}
```

**æŠ€æœ¯äº®ç‚¹**ï¼š
- **äº‹åŠ¡å¤„ç†**ï¼šä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§
- **éƒ¨åˆ†å¤±è´¥å¤„ç†**ï¼šå•ä¸ªäº‹ä»¶å¤±è´¥ä¸å½±å“å…¶ä»–äº‹ä»¶ï¼Œè¿”å›å¤±è´¥äº‹ä»¶åˆ—è¡¨
- **è‡ªåŠ¨åˆ›å»ºäº‹ä»¶å®šä¹‰**ï¼šå¦‚æœäº‹ä»¶å®šä¹‰ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨åˆ›å»º
- **é”™è¯¯éš”ç¦»**ï¼šæ¯ä¸ªäº‹ä»¶çš„é”™è¯¯ç‹¬ç«‹å¤„ç†ï¼Œä¸ä¼šå¯¼è‡´æ•´ä¸ªæ‰¹é‡å¤±è´¥

---

## ğŸš€ ä¸ƒã€é€šä¿¡æ€§èƒ½ä¼˜åŒ–

### 7.1 è¯·æ±‚ä¼˜åŒ–

**æ‰¹é‡å‘é€**ï¼š
- 50ä¸ªäº‹ä»¶æ‰“åŒ…æˆ1ä¸ªè¯·æ±‚ï¼Œå‡å°‘98%çš„HTTPè¯·æ±‚
- å‡å°‘ç½‘ç»œå¼€é”€ï¼ˆHTTPå¤´éƒ¨ã€TCPè¿æ¥å»ºç«‹ï¼‰
- æé«˜æœåŠ¡å™¨å¤„ç†æ•ˆç‡ï¼ˆæ‰¹é‡æ’å…¥ï¼‰

**è¯·æ±‚åˆå¹¶**ï¼š
```typescript
// å‰ç«¯ï¼šå¹¶å‘è¯·æ±‚åˆå¹¶
const [stats, overview, topProjects] = await Promise.all([
  apiService.getStats(params),
  apiService.getDashboardOverview(projectId),
  apiService.getTopProjects(params)
]);
```

### 7.2 è¶…æ—¶æ§åˆ¶

**åˆ†å±‚è¶…æ—¶ç­–ç•¥**ï¼š
- **æ™®é€šAPIè¯·æ±‚**ï¼š10ç§’ï¼ˆé»˜è®¤ï¼‰
- **AIæ€»ç»“è¯·æ±‚**ï¼š120ç§’ï¼ˆå¤„ç†å¤§é‡æ•°æ®ï¼‰
- **é¢„æµ‹è¯·æ±‚**ï¼š60ç§’ï¼ˆå•ä¸ªæŒ‡æ ‡ï¼‰æˆ–120ç§’ï¼ˆæ‰¹é‡é¢„æµ‹ï¼‰
- **SDKæ‰¹é‡å‘é€**ï¼š10ç§’ï¼ˆAbortControllerï¼‰

**å®ç°æ–¹å¼**ï¼š
```typescript
// Axiosè¶…æ—¶
const instance = axios.create({
  timeout: 10000
});

// å•ä¸ªè¯·æ±‚è¶…æ—¶
await api.post('/ai-summary/send-now', {}, {
  timeout: 120000
});

// Fetchè¶…æ—¶ï¼ˆAbortControllerï¼‰
const controller = new AbortController();
const timeoutId = setTimeout(() => controller.abort(), 10000);
const response = await fetch(url, {
  signal: controller.signal
});
clearTimeout(timeoutId);
```

### 7.3 é”™è¯¯é‡è¯•

**å‰ç«¯é‡è¯•**ï¼š
- SDKä½¿ç”¨æŒ‡æ•°é€€é¿é‡è¯•
- æœ€å¤šé‡è¯•3æ¬¡
- é‡è¯•å¤±è´¥åä¿å­˜åˆ°ç¦»çº¿å­˜å‚¨

**åç«¯é‡è¯•**ï¼š
- AIæœåŠ¡è°ƒç”¨ä½¿ç”¨æŒ‡æ•°é€€é¿é‡è¯•
- æœ€å¤šé‡è¯•2æ¬¡
- é‡è¯•å¤±è´¥åä½¿ç”¨é™çº§æ–¹æ¡ˆ

---

## ğŸ”„ å…«ã€æ•°æ®æµç¤ºä¾‹

### 8.1 äº‹ä»¶ä¸ŠæŠ¥æµç¨‹

```
ç”¨æˆ·æ“ä½œ
  â†“
SDK.track('page_view', params)
  â†“
æ·»åŠ åˆ°äº‹ä»¶é˜Ÿåˆ—ï¼ˆä¼˜å…ˆçº§ï¼šnormalï¼‰
  â†“
æ£€æŸ¥æ‰¹é‡å¤§å°ï¼ˆè‡ªé€‚åº”ï¼š10-100ä¸ªï¼‰
  â†“
è¾¾åˆ°æ‰¹é‡å¤§å°æˆ–å®šæ—¶è§¦å‘ï¼ˆ5ç§’ï¼‰
  â†“
å‹ç¼©æ•°æ®ï¼ˆå»é‡ã€å­—å…¸å‹ç¼©ï¼‰
  â†“
å‘é€æ‰¹é‡è¯·æ±‚ï¼ˆPOST /api/trackï¼‰
  â†“
åç«¯æ¥æ”¶å¹¶éªŒè¯
  â†“
æ•°æ®åº“äº‹åŠ¡æ‰¹é‡æ’å…¥
  â†“
è¿”å›æˆåŠŸ/å¤±è´¥äº‹ä»¶åˆ—è¡¨
  â†“
SDKå¤„ç†å¤±è´¥äº‹ä»¶ï¼ˆé‡è¯•æˆ–ç¦»çº¿å­˜å‚¨ï¼‰
```

### 8.2 é¢„æµ‹è¯·æ±‚æµç¨‹

```
å‰ç«¯å‘èµ·é¢„æµ‹è¯·æ±‚
  â†“
POST /api/prediction/predict
  â†“
åç«¯éªŒè¯Tokenå’Œå‚æ•°
  â†“
è·å–å†å²æ•°æ®ï¼ˆMySQLæŸ¥è¯¢ï¼‰
  â†“
è°ƒç”¨MLæœåŠ¡ï¼ˆPOST http://127.0.0.1:5000/predictï¼‰
  â†“
MLæœåŠ¡è®­ç»ƒ/é¢„æµ‹ï¼ˆLSTM/GRUæ¨¡å‹ï¼‰
  â†“
è¿”å›é¢„æµ‹ç»“æœ
  â†“
åç«¯ä¿å­˜é¢„æµ‹è®°å½•ï¼ˆMySQLï¼‰
  â†“
è¿”å›é¢„æµ‹ç»“æœç»™å‰ç«¯
  â†“
å‰ç«¯å¯è§†åŒ–å±•ç¤ºï¼ˆå›¾è¡¨+è¡¨æ ¼ï¼‰
```

### 8.3 AIæ€»ç»“æµç¨‹

```
å®šæ—¶ä»»åŠ¡è§¦å‘ï¼ˆnode-cronï¼‰
  â†“
è·å–æ‰€æœ‰é¡¹ç›®æ•°æ®ï¼ˆMySQLæŸ¥è¯¢ï¼‰
  â†“
æ•°æ®èšåˆå’Œæ ¼å¼åŒ–
  â†“
æ£€æŸ¥æ•°æ®é‡ï¼Œå†³å®šæ˜¯å¦åˆ†æ‰¹
  â†“
è°ƒç”¨OpenAI APIï¼ˆåˆ†æ‰¹å¤„ç†ï¼‰
  â†“
è§£æAIè¿”å›çš„ç»“æ„åŒ–æ•°æ®
  â†“
ç”Ÿæˆé‚®ä»¶å†…å®¹
  â†“
å‘é€é‚®ä»¶ï¼ˆNodemailerï¼‰
  â†“
è®°å½•å‘é€æ—¥å¿—
```

---

## ğŸ’¡ ä¹ã€æŠ€æœ¯äº®ç‚¹æ€»ç»“

### 1. åˆ†å±‚é€šä¿¡æ¶æ„
- **å‰ç«¯ â†” åç«¯**ï¼šAxios + æ‹¦æˆªå™¨ï¼Œç»Ÿä¸€è®¤è¯å’Œé”™è¯¯å¤„ç†
- **SDK â†” åç«¯**ï¼šåŸç”ŸFetchï¼Œè½»é‡çº§ï¼Œæ‰¹é‡å‘é€
- **åç«¯ â†” MLæœåŠ¡**ï¼šAxiosï¼Œå¥åº·æ£€æŸ¥ï¼Œè¶…æ—¶æ§åˆ¶

### 2. æ‰¹é‡é€šä¿¡ä¼˜åŒ–
- **æ‰¹é‡å‘é€**ï¼š50ä¸ªäº‹ä»¶1ä¸ªè¯·æ±‚ï¼Œå‡å°‘98%è¯·æ±‚
- **è‡ªé€‚åº”æ‰¹é‡**ï¼šæ ¹æ®ç½‘ç»œçŠ¶å†µåŠ¨æ€è°ƒæ•´ï¼ˆ10-100ä¸ªï¼‰
- **äº‹åŠ¡å¤„ç†**ï¼šæ•°æ®åº“äº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§

### 3. é”™è¯¯å¤„ç†æœºåˆ¶
- **é”™è¯¯åˆ†ç±»**ï¼šnetwork/timeout/server/client/unknown
- **æŒ‡æ•°é€€é¿é‡è¯•**ï¼š2^n + æŠ–åŠ¨æœºåˆ¶
- **é™çº§æ–¹æ¡ˆ**ï¼šAIå¤±è´¥æ—¶ä½¿ç”¨åŸºç¡€æ€»ç»“ï¼ŒMLæœåŠ¡ä¸å¯ç”¨æ—¶æç¤ºç”¨æˆ·

### 4. è®¤è¯ä¸å®‰å…¨
- **JWT Token**ï¼šæ— çŠ¶æ€è®¤è¯ï¼Œè‡ªåŠ¨æ³¨å…¥
- **è·¯ç”±ä¿æŠ¤**ï¼šå‰ç«¯è·¯ç”±å®ˆå« + åç«¯ä¸­é—´ä»¶
- **å‚æ•°åŒ–æŸ¥è¯¢**ï¼šé˜²æ­¢SQLæ³¨å…¥

### 5. æ€§èƒ½ä¼˜åŒ–
- **è¯·æ±‚åˆå¹¶**ï¼šPromise.allå¹¶å‘è¯·æ±‚
- **è¶…æ—¶æ§åˆ¶**ï¼šä¸åŒæ“ä½œä¸åŒè¶…æ—¶æ—¶é—´
- **æ•°æ®å‹ç¼©**ï¼šç¦»çº¿å­˜å‚¨å‹ç¼©50-80%

---

## ğŸ¯ åã€é¢è¯•å®˜å¯èƒ½é—®çš„é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆSDKä½¿ç”¨Fetchè€Œä¸æ˜¯Axiosï¼Ÿ

**å›ç­”è¦ç‚¹**ï¼š
- **ä½“ç§¯è€ƒè™‘**ï¼šAxiosçº¦13KBï¼ŒFetchæ˜¯åŸç”ŸAPIï¼ŒSDKä½“ç§¯æ›´å°
- **ä¾èµ–ç®¡ç†**ï¼šé¿å…å¼•å…¥é¢å¤–ä¾èµ–ï¼Œå‡å°‘æ‰“åŒ…ä½“ç§¯
- **åŠŸèƒ½è¶³å¤Ÿ**ï¼šSDKåªéœ€è¦åŸºæœ¬çš„HTTPè¯·æ±‚ï¼ŒFetchå®Œå…¨æ»¡è¶³éœ€æ±‚
- **å…¼å®¹æ€§**ï¼šç°ä»£æµè§ˆå™¨éƒ½æ”¯æŒFetchï¼Œæ— éœ€polyfill

### Q2: æ‰¹é‡å‘é€å¦‚ä½•ä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Ÿ

**å›ç­”è¦ç‚¹**ï¼š
1. **ç¦»çº¿å­˜å‚¨**ï¼šç½‘ç»œæ–­å¼€æ—¶ä¿å­˜åˆ°localStorageï¼ˆå‹ç¼©å­˜å‚¨ï¼‰
2. **è‡ªåŠ¨é‡è¯•**ï¼šå¤±è´¥äº‹ä»¶è‡ªåŠ¨é‡è¯•ï¼ˆæŒ‡æ•°é€€é¿ï¼Œæœ€å¤š3æ¬¡ï¼‰
3. **ç½‘ç»œç›‘å¬**ï¼šç›‘å¬online/offlineäº‹ä»¶ï¼Œè‡ªåŠ¨æ¢å¤
4. **é¡µé¢å¸è½½**ï¼šbeforeunloadæ—¶å¼ºåˆ¶å‘é€
5. **äº‹åŠ¡å¤„ç†**ï¼šåç«¯ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§

### Q3: å¦‚ä½•å¤„ç†è·¨åŸŸé—®é¢˜ï¼Ÿ

**å›ç­”è¦ç‚¹**ï¼š
- **å¼€å‘ç¯å¢ƒ**ï¼šViteä»£ç†é…ç½®ï¼Œ`/api`è‡ªåŠ¨ä»£ç†åˆ°`http://localhost:3000/api`
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šnginxåå‘ä»£ç†æˆ–åç«¯é…ç½®CORS
- **SDKé€šä¿¡**ï¼šSDKç›´æ¥è°ƒç”¨åç«¯APIï¼Œéœ€è¦åç«¯é…ç½®CORSå…è®¸è·¨åŸŸ

### Q4: å¦‚ä½•ä¿è¯é€šä¿¡çš„å®‰å…¨æ€§ï¼Ÿ

**å›ç­”è¦ç‚¹**ï¼š
1. **HTTPSä¼ è¾“**ï¼šç”Ÿäº§ç¯å¢ƒä½¿ç”¨HTTPSåŠ å¯†ä¼ è¾“
2. **JWT Token**ï¼šTokenå­˜å‚¨åœ¨localStorageï¼Œæ¯æ¬¡è¯·æ±‚è‡ªåŠ¨æ·»åŠ 
3. **Tokenè¿‡æœŸ**ï¼šTokenè¿‡æœŸåè‡ªåŠ¨è·³è½¬ç™»å½•
4. **å‚æ•°åŒ–æŸ¥è¯¢**ï¼šé˜²æ­¢SQLæ³¨å…¥
5. **è¾“å…¥éªŒè¯**ï¼šå‰åç«¯åŒé‡éªŒè¯

### Q5: æ‰¹é‡å‘é€çš„æ‰¹é‡å¤§å°å¦‚ä½•ç¡®å®šï¼Ÿ

**å›ç­”è¦ç‚¹**ï¼š
- **é»˜è®¤å€¼**ï¼š50ä¸ªäº‹ä»¶/æ‰¹ï¼ˆç»è¿‡æµ‹è¯•éªŒè¯çš„å¹³è¡¡å€¼ï¼‰
- **è‡ªé€‚åº”è°ƒæ•´**ï¼šæ ¹æ®ç½‘ç»œçŠ¶å†µï¼ˆ10-100ä¸ªï¼‰å’Œé˜Ÿåˆ—é•¿åº¦åŠ¨æ€è°ƒæ•´
- **è€ƒè™‘å› ç´ **ï¼š
  - ç½‘ç»œå»¶è¿Ÿï¼ˆå»¶è¿Ÿé«˜æ—¶å¢å¤§æ‰¹é‡ï¼‰
  - æœåŠ¡å™¨å¤„ç†èƒ½åŠ›
  - å®æ—¶æ€§è¦æ±‚ï¼ˆå®æ—¶æ€§è¦æ±‚é«˜æ—¶å‡å°æ‰¹é‡ï¼‰
  - æ•°æ®å¤§å°ï¼ˆå•ä¸ªäº‹ä»¶å¤§å°å½±å“æ‰¹é‡å¤§å°ï¼‰

---

## ğŸ“Š åä¸€ã€é€šä¿¡æ€§èƒ½æ•°æ®

### è¯·æ±‚ä¼˜åŒ–æ•ˆæœ

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| HTTPè¯·æ±‚æ¬¡æ•° | æ¯ä¸ªäº‹ä»¶1æ¬¡ | æ¯æ‰¹50ä¸ªäº‹ä»¶1æ¬¡ | å‡å°‘98% |
| ç½‘ç»œå¼€é”€ | é«˜ï¼ˆæ¯ä¸ªè¯·æ±‚éƒ½æœ‰å¤´éƒ¨ï¼‰ | ä½ï¼ˆæ‰¹é‡è¯·æ±‚å…±äº«å¤´éƒ¨ï¼‰ | æ˜¾è‘—é™ä½ |
| æœåŠ¡å™¨å‹åŠ› | é«˜ï¼ˆé¢‘ç¹è¿æ¥ï¼‰ | ä½ï¼ˆæ‰¹é‡å¤„ç†ï¼‰ | æ˜¾è‘—é™ä½ |

### é€šä¿¡æˆåŠŸç‡

| åœºæ™¯ | æˆåŠŸç‡ | ä¼˜åŒ–æªæ–½ |
|------|--------|----------|
| æ­£å¸¸ç½‘ç»œ | > 99.5% | æ‰¹é‡å‘é€ã€è‡ªåŠ¨é‡è¯• |
| å¼±ç½‘ç¯å¢ƒ | > 95% | è‡ªé€‚åº”æ‰¹é‡ã€æŒ‡æ•°é€€é¿ |
| ç¦»çº¿æ¢å¤ | 100% | ç¦»çº¿å­˜å‚¨ã€è‡ªåŠ¨å‘é€ |

---

## ğŸ”§ åäºŒã€é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡é…ç½®

**å‰ç«¯**ï¼ˆ`.env`ï¼‰ï¼š
```env
VITE_API_BASE_URL=http://localhost:3000/api
```

**åç«¯**ï¼ˆ`server/.env`ï¼‰ï¼š
```env
# JWTé…ç½®
JWT_SECRET=your-secret-key
JWT_EXPIRES_IN=7d

# MLæœåŠ¡é…ç½®
ML_SERVICE_URL=http://127.0.0.1:5000

# OpenAIé…ç½®
OPENAI_API_KEY=sk-xxx
OPENAI_MODEL=gpt-3.5-turbo
OPENAI_TIMEOUT_MS=120000

# AIæ€»ç»“é…ç½®
AI_MAX_PROJECTS=50
AI_MAX_PROJECTS_PER_BATCH=10
AI_MAX_PROMPT_TOKENS=3000
```

---

## ğŸ“ æ€»ç»“

é¡¹ç›®çš„æ•°æ®é€šä¿¡å®ç°ä½“ç°äº†ä»¥ä¸‹ç‰¹ç‚¹ï¼š

1. **åˆ†å±‚æ¸…æ™°**ï¼šå‰ç«¯ã€SDKã€åç«¯ã€MLæœåŠ¡å„å±‚èŒè´£æ˜ç¡®
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šæ‰¹é‡å‘é€ã€è‡ªé€‚åº”è°ƒæ•´ã€æ•°æ®å‹ç¼©
3. **å¯é æ€§é«˜**ï¼šç¦»çº¿å­˜å‚¨ã€è‡ªåŠ¨é‡è¯•ã€é”™è¯¯å¤„ç†
4. **å®‰å…¨æ€§å¼º**ï¼šJWTè®¤è¯ã€å‚æ•°åŒ–æŸ¥è¯¢ã€HTTPSä¼ è¾“
5. **å¯ç»´æŠ¤æ€§å¥½**ï¼šç»Ÿä¸€å°è£…ã€ç±»å‹å®‰å…¨ã€é”™è¯¯å¤„ç†

è¿™å¥—é€šä¿¡æœºåˆ¶ä¿è¯äº†ç³»ç»Ÿåœ¨é«˜å¹¶å‘ã€å¼±ç½‘ç¯å¢ƒä¸‹çš„ç¨³å®šè¿è¡Œï¼Œæ•°æ®ä¸ŠæŠ¥æˆåŠŸç‡ > 99.5%ã€‚


